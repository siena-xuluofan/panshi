<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问题处理</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif, 'Apple Color Emoji',
                'Segoe UI Emoji', 'Segoe UI Symbol';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f5f5f5;
            color: rgba(0, 0, 0, 0.85);
            line-height: 1.5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-header {
            background-color: #fff;
            padding: 16px 24px;
            margin-bottom: 24px;
            border-radius: 6px;
            box-shadow: 0 1px 0 0 rgba(0, 0, 0, 0.05);
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .card {
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px 0 rgba(0, 0, 0, 0.02);
            margin-bottom: 24px;
            padding: 24px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #40a9ff;
        }
        
        .btn-text {
            background-color: transparent;
            color: #1890ff;
            border: 0;
            padding: 0;
        }
        
        .btn-text:hover {
            color: #40a9ff;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }
        
        .table th,
        .table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .table th {
            font-weight: 500;
            color: rgba(0, 0, 0, 0.85);
            background-color: #fafafa;
        }
        
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .tag-success {
            background-color: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            border-color: #40a9ff;
            outline: 0;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 6px;
            width: 90%;
            max-width: 600px;
            padding: 24px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 16px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .modal-footer {
            margin-top: 24px;
            text-align: right;
        }
        
        .modal-footer .btn {
            margin-left: 8px;
        }
        
        .comment-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 16px 0;
        }
        
        .comment-item:last-child {
            border-bottom: none;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .comment-author {
            font-weight: 500;
        }
        
        .comment-time {
            color: rgba(0, 0, 0, 0.45);
            font-size: 12px;
        }
        
        .comment-content {
            color: rgba(0, 0, 0, 0.85);
        }
        
        .action-buttons {
            margin-bottom: 16px;
        }
        
        textarea {
            resize: vertical;
        }
        
        .datetime-picker {
            position: relative;
        }
        
        .datetime-picker-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .datetime-picker-input:focus {
            border-color: #40a9ff;
            outline: 0;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">问题处理</h1>
        </div>

        <!-- 处理记录部分 -->
        <div class="card">
            <h2 class="section-title">处理记录</h2>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showAddModal()">新增处理事项</button>
            </div>
            <table class="table" id="recordsTable">
                <thead>
                    <tr>
                        <th width="180">创建时间</th>
                        <th>处理事项</th>
                        <th width="120">处理人</th>
                        <th width="180">预计完成时间</th>
                        <th width="180">实际完成时间</th>
                        <th width="120">处理结果</th>
                        <th width="120">处理完成填写人</th>
                    </tr>
                </thead>
                <tbody id="recordsBody">
                    <!-- 动态生成 -->
                </tbody>
            </table>
        </div>

        <!-- 评论部分 -->
        <div class="card">
            <h2 class="section-title">评论</h2>
            <div class="comment-input">
                <div class="form-group">
                    <textarea id="commentText" class="form-control" rows="3" placeholder="请输入评论内容"></textarea>
                </div>
                <div style="text-align: right;">
                    <button class="btn btn-primary" onclick="addComment()">提交评论</button>
                </div>
            </div>
            <hr style="margin: 16px 0; border: 0; border-top: 1px solid #f0f0f0;">
            <div class="comment-list" id="commentsList">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 新增处理事项弹窗 -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">新增处理事项</div>
            <div class="form-group">
                <label class="form-label">处理事项 *</label>
                <input type="text" class="form-control" id="issueInput" placeholder="请输入处理事项">
            </div>
            <div class="form-group">
                <label class="form-label">处理人 *</label>
                <input type="text" class="form-control" id="processorInput" placeholder="请输入处理人">
            </div>
            <div class="form-group">
                <label class="form-label">预计完成时间 *</label>
                <input type="date" class="form-control" id="estimatedTimeInput">
            </div>
            <div class="form-group">
                <label class="form-label">实际完成时间</label>
                <input type="date" class="form-control" id="actualTimeInput" placeholder="请输入实际完成时间（非必填）">
            </div>
            <div class="form-group">
                <label class="form-label">处理结果</label>
                <input type="text" class="form-control" id="resultInput" placeholder="请输入处理结果（非必填）">
            </div>
            <div class="modal-footer">
                <button class="btn" style="background-color: #f0f0f0;" onclick="hideAddModal()">取消</button>
                <button class="btn btn-primary" onclick="submitRecord()">确定</button>
            </div>
        </div>
    </div>

    <!-- 处理结果弹窗 -->
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <div class="modal-header">填写实际完成时间</div>
            <div class="form-group">
                <label class="form-label">实际完成时间 *</label>
                <input type="date" class="form-control" id="resultTimeInput">
            </div>
            <div class="form-group">
                <label class="form-label">处理结果 *</label>
                <input type="text" class="form-control" id="resultInput" placeholder="请输入处理结果">
            </div>
            <div class="modal-footer">
                <button class="btn" style="background-color: #f0f0f0;" onclick="hideResultModal()">取消</button>
                <button class="btn btn-primary" onclick="submitResult()">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 模拟处理记录数据
        let records = [
            {
                id: 1,
                createTime: '2023-11-20 10:30:00',
                issue: '修复登录页面BUG',
                processor: '张三',
                estimatedCompleteTime: '2023-11-21',
                actualCompleteTime: '2023-11-21',
                result: '已修复',
                resultFiller: '李四'
            },
            {
                id: 2,
                createTime: '2023-11-19 14:20:00',
                issue: '优化数据库查询性能',
                processor: '王五',
                estimatedCompleteTime: '2023-11-20',
                actualCompleteTime: '',
                result: '',
                resultFiller: ''
            },
            {
                id: 3,
                createTime: '2023-11-18 09:15:00',
                issue: '更新用户手册文档',
                processor: '赵六',
                estimatedCompleteTime: '2023-11-19',
                actualCompleteTime: '2023-11-19',
                result: '已完成',
                resultFiller: '赵六'
            }
        ];

        // 模拟评论数据
        let comments = [
            {
                id: 1,
                author: '李四',
                time: '2023-11-20 16:30:00',
                content: '登录页面BUG已经修复，请测试验证。'
            },
            {
                id: 2,
                author: '张三',
                time: '2023-11-20 17:15:00',
                content: '测试通过，功能正常。'
            },
            {
                id: 3,
                author: '王五',
                time: '2023-11-21 09:45:00',
                content: '数据库查询优化方案已实施，性能提升约30%。'
            }
        ];

        // 当前编辑的记录ID
        let currentRecordId = null;

        // 格式化日期时间
        function formatDateTime(date) {
            if (!date) return '';
            if (typeof date === 'string') return date;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // 将date格式的值转换为显示格式
        function formatDate(dateValue) {
            if (!dateValue) return '';
            const date = new Date(dateValue);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // 将显示格式的日期转换为date格式
        function toDate(dateStr) {
            if (!dateStr) return '';
            // 只保留日期部分，去掉时间部分
            return dateStr.split(' ')[0];
        }

        // 渲染处理记录表格
        function renderRecords() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            
            records.sort((a, b) => new Date(b.createTime) - new Date(a.createTime));
            
            records.forEach(record => {
                const row = document.createElement('tr');
                
                // 处理结果以文本形式呈现
                const resultText = record.result ? record.result : '';
                
                // 实际完成时间处提供填写按钮
                const actualTimeCell = record.actualCompleteTime ? 
                    record.actualCompleteTime : 
                    `<button class="btn btn-text" onclick="showResultModal(${record.id})">填写</button>`;
                
                row.innerHTML = `
                    <td>${record.createTime}</td>
                    <td>${record.issue}</td>
                    <td>${record.processor}</td>
                    <td>${record.estimatedCompleteTime}</td>
                    <td>${actualTimeCell}</td>
                    <td>${resultText}</td>
                    <td>${record.resultFiller || ''}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 渲染评论列表
        function renderComments() {
            const list = document.getElementById('commentsList');
            list.innerHTML = '';
            
            comments.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            comments.forEach(comment => {
                const item = document.createElement('div');
                item.className = 'comment-item';
                item.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">${comment.author}</span>
                        <span class="comment-time">${comment.time}</span>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                `;
                list.appendChild(item);
            });
        }

        // 显示新增处理事项弹窗
        function showAddModal() {
            document.getElementById('addModal').style.display = 'flex';
        }

        // 隐藏新增处理事项弹窗
        function hideAddModal() {
            document.getElementById('addModal').style.display = 'none';
            // 清空表单
            document.getElementById('issueInput').value = '';
            document.getElementById('processorInput').value = '';
            document.getElementById('estimatedTimeInput').value = '';
            document.getElementById('actualTimeInput').value = '';
            document.getElementById('resultInput').value = '';
        }

        // 提交新增处理事项
        function submitRecord() {
            const issue = document.getElementById('issueInput').value.trim();
            const processor = document.getElementById('processorInput').value.trim();
            const estimatedTimeValue = document.getElementById('estimatedTimeInput').value;
            const actualTimeValue = document.getElementById('actualTimeInput').value;
            const result = document.getElementById('resultInput').value.trim();
            
            if (!issue || !processor || !estimatedTimeValue) {
                alert('请填写所有必填项');
                return;
            }
            
            // 将date格式转换为显示格式
            const estimatedTime = formatDate(estimatedTimeValue);
            const actualTime = actualTimeValue ? formatDate(actualTimeValue) : '';
            
            const newRecord = {
                id: records.length + 1,
                createTime: formatDateTime(new Date()),
                issue: issue,
                processor: processor,
                estimatedCompleteTime: estimatedTime,
                actualCompleteTime: actualTime,
                result: result,
                resultFiller: result ? '当前用户' : ''
            };
            
            records.unshift(newRecord);
            renderRecords();
            hideAddModal();
            alert('处理事项添加成功');
        }

        // 显示处理结果弹窗
        function showResultModal(recordId) {
            currentRecordId = recordId;
            const record = records.find(r => r.id === recordId);
            document.getElementById('resultInput').value = record.result || '';
            // 将显示格式的日期转换为date格式
            document.getElementById('resultTimeInput').value = toDate(record.actualCompleteTime);
            document.getElementById('resultModal').style.display = 'flex';
        }

        // 隐藏处理结果弹窗
        function hideResultModal() {
            document.getElementById('resultModal').style.display = 'none';
            currentRecordId = null;
        }

        // 提交处理结果
        function submitResult() {
            const result = document.getElementById('resultInput').value.trim();
            const actualTimeValue = document.getElementById('resultTimeInput').value;
            
            if (!result) {
                alert('请填写处理结果');
                return;
            }
            
            if (!actualTimeValue) {
                alert('请填写实际完成时间');
                return;
            }
            
            // 将date格式转换为显示格式
            const actualTime = formatDate(actualTimeValue);
            
            const recordIndex = records.findIndex(r => r.id === currentRecordId);
            if (recordIndex !== -1) {
                records[recordIndex].result = result;
                records[recordIndex].actualCompleteTime = actualTime;
                records[recordIndex].resultFiller = '当前用户';
                renderRecords();
                hideResultModal();
                alert('处理结果已更新');
            }
        }

        // 添加评论
        function addComment() {
            const commentText = document.getElementById('commentText').value.trim();
            
            if (!commentText) {
                alert('请输入评论内容');
                return;
            }
            
            const newComment = {
                id: comments.length + 1,
                author: '当前用户',
                time: formatDateTime(new Date()),
                content: commentText
            };
            
            comments.unshift(newComment);
            renderComments();
            document.getElementById('commentText').value = '';
            alert('评论添加成功');
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            renderRecords();
            renderComments();
        });

        // 点击模态框背景关闭模态框
        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideAddModal();
            }
        });

        document.getElementById('resultModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideResultModal();
            }
        });
    </script>
</body>
</html>