{"version":3,"file":"ImageViewer.js","sources":["../../../components/image-viewer/ImageViewer.tsx"],"sourcesContent":["import React, { useMemo, useState } from 'react';\nimport { createPortal } from 'react-dom';\nimport { isFunction, isNumber } from 'lodash-es';\nimport { ImageModal } from './ImageViewerModal';\nimport { imageViewerDefaultProps } from './defaultProps';\nimport type { TdImageViewerProps } from './type';\nimport type { ImageModalProps } from './ImageViewerModal';\nimport type { StyledProps, TNode } from '../common';\nimport useImageScale from './hooks/useImageScale';\nimport useList from './hooks/useList';\nimport useViewerScale from './hooks/useViewerScale';\nimport useControlled from '../hooks/useControlled';\nimport useDefaultProps from '../hooks/useDefaultProps';\nimport { canUseDocument } from '../_util/dom';\nimport useAttach from '../hooks/useAttach';\nimport useIndex from './hooks/useIndex';\n\nexport interface ImageViewerProps extends TdImageViewerProps, StyledProps {}\n\nconst ImageViewer: React.FC<ImageViewerProps> = (originalProps) => {\n  const props = useDefaultProps<ImageViewerProps>(originalProps, imageViewerDefaultProps);\n  const { attach, mode, trigger, images, title, imageScale: imageScaleD, viewerScale: viewerScaleD } = props;\n\n  const imageViewerAttach = useAttach('imageViewer', attach);\n  const [visible, setVisible] = useControlled(props, 'visible', (visible, context) => {\n    !visible && props?.onClose?.(context);\n  });\n\n  const [visibled, setVisibled] = useState(false);\n  const list = useList(images);\n  const { index, setIndex } = useIndex(props, images);\n  const imageScale = useImageScale(imageScaleD);\n  const viewerScale = useViewerScale(viewerScaleD);\n\n  const isMini = mode === 'modeless';\n\n  const close: ImageModalProps['onClose'] = (context) => {\n    setVisible(false, context);\n    setTimeout(() => setVisibled(false), 196);\n  };\n\n  const open = (index?: number) => {\n    if (!images) return;\n    if (isNumber(index)) {\n      setIndex(index);\n    }\n    setVisible(true, null);\n    setVisibled(true);\n  };\n  // todo 兼容旧api，新： open close 旧： onOpen, onClose\n  // @ts-ignore TODO 待类型完善后移除\n  const uiImage: TNode = isFunction(trigger) ? trigger({ open, close, onOpen: open, onClose: close }) : trigger;\n\n  const attachElement = useMemo(() => {\n    if (!canUseDocument || !imageViewerAttach) return null;\n\n    if (typeof imageViewerAttach === 'string') {\n      return document.querySelector(imageViewerAttach);\n    }\n    if (isFunction(imageViewerAttach)) {\n      return imageViewerAttach();\n    }\n  }, [imageViewerAttach]);\n\n  return (\n    <>\n      {uiImage}\n      {(visibled || visible) &&\n        createPortal(\n          <ImageModal\n            title={title}\n            visible={visible}\n            images={list}\n            isMini={isMini}\n            imageScale={imageScale}\n            viewerScale={viewerScale}\n            zIndex={props.zIndex}\n            defaultIndex={props.defaultIndex}\n            index={index}\n            onIndexChange={setIndex}\n            onDownload={props.onDownload}\n            draggable={props.draggable}\n            closeOnOverlay={props.closeOnOverlay}\n            closeBtn={props.closeBtn}\n            showOverlay={props.showOverlay}\n            closeOnEscKeydown={props.closeOnEscKeydown}\n            onClose={close}\n            onOpen={open}\n            imageReferrerpolicy={props.imageReferrerpolicy}\n          />,\n          attachElement,\n        )}\n    </>\n  );\n};\n\nImageViewer.displayName = 'ImageViewer';\n\nexport default ImageViewer;\n"],"names":["ImageViewer","originalProps","props","useDefaultProps","imageViewerDefaultProps","attach","mode","trigger","images","title","imageScaleD","imageScale","viewerScaleD","viewerScale","imageViewerAttach","useAttach","_useControlled","useControlled","visible","context","_props$onClose","onClose","call","_useControlled2","_slicedToArray","setVisible","_useState","useState","_useState2","visibled","setVisibled","list","useList","_useIndex","useIndex","index","setIndex","useImageScale","useViewerScale","isMini","close","setTimeout","open","isNumber","uiImage","isFunction","onOpen","attachElement","useMemo","canUseDocument","document","querySelector","React","createElement","Fragment","createPortal","ImageModal","zIndex","defaultIndex","onIndexChange","onDownload","draggable","closeOnOverlay","closeBtn","showOverlay","closeOnEscKeydown","imageReferrerpolicy","displayName"],"mappings":"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"}