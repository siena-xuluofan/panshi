{"version":3,"file":"FormList.js","sources":["../../../components/form/FormList.tsx"],"sourcesContent":["import React, { useEffect, useImperativeHandle, useRef, useState } from 'react';\nimport { flattenDeep, get, merge, set, unset } from 'lodash-es';\nimport log from '@tdesign/common-js/log/index';\nimport { FormListContext, useFormContext } from './FormContext';\nimport { HOOK_MARK } from './hooks/useForm';\nimport { calcFieldValue } from './utils';\n\nimport type { FormItemInstance } from './FormItem';\nimport type { FormListField, FormListFieldOperation, TdFormListProps } from './type';\n\nlet key = 0;\n\nconst FormList: React.FC<TdFormListProps> = (props) => {\n  const {\n    formMapRef,\n    form,\n    onFormItemValueChange,\n    initialData: initialDataFromForm,\n    resetType: resetTypeFromContext,\n  } = useFormContext();\n  const { name, rules, children } = props;\n\n  const originalInitialData = props.initialData || get(initialDataFromForm, name) || [];\n  const storeValue = get(form?.store, name);\n  const initialData = storeValue ?? originalInitialData;\n\n  const [formListValue, setFormListValue] = useState(initialData);\n  const [fields, setFields] = useState<Array<FormListField>>(() =>\n    initialData.map((data, index) => ({\n      data: { ...data },\n      key: (key += 1),\n      name: index,\n      isListField: true,\n    })),\n  );\n  const formListMapRef = useRef(new Map()); // 收集 formItem 实例\n  const formListRef = useRef<FormItemInstance>(null); // 当前 formList 实例\n  const fieldsTaskQueueRef = useRef([]); // 记录更改 fields 数据后 callback 队列\n  const snakeName = []\n    .concat(name)\n    .filter((item) => item !== undefined)\n    .toString(); // 转化 name\n\n  const isMounted = useRef(false);\n\n  useEffect(\n    () => () => {\n      isMounted.current = false;\n    },\n    [],\n  );\n\n  const operation: FormListFieldOperation = {\n    add(defaultValue?: any, insertIndex?: number) {\n      const cloneFields = [...fields];\n      const index = insertIndex ?? cloneFields.length;\n      cloneFields.splice(index, 0, {\n        key: (key += 1),\n        name: index,\n        isListField: true,\n      });\n      cloneFields.forEach((field, index) => Object.assign(field, { name: index }));\n      setFields(cloneFields);\n\n      const nextFormListValue = [...formListValue];\n      if (typeof defaultValue !== 'undefined') {\n        nextFormListValue[index] = defaultValue;\n        setFormListValue(nextFormListValue);\n      }\n      set(form?.store, flattenDeep([name]), nextFormListValue);\n\n      const fieldValue = calcFieldValue(name, nextFormListValue);\n      requestAnimationFrame(() => {\n        onFormItemValueChange?.({ ...fieldValue });\n      });\n    },\n    remove(index: number | number[]) {\n      const nextFields = fields\n        .filter((item) => {\n          if (Array.isArray(index)) return !index.includes(item.name);\n          return item.name !== index;\n        })\n        .map((field, i) => ({ ...field, name: i }));\n      setFields(nextFields);\n\n      const nextFormListValue = formListValue.filter((_, idx) => idx !== index);\n      setFormListValue(nextFormListValue);\n\n      unset(form?.store, flattenDeep([name, index]));\n\n      const fieldValue = calcFieldValue(name, nextFormListValue);\n      requestAnimationFrame(() => {\n        onFormItemValueChange?.({ ...fieldValue });\n      });\n    },\n    move(from: number, to: number) {\n      const cloneFields = [...fields];\n      const fromItem = { ...cloneFields[from] };\n      const toItem = { ...cloneFields[to] };\n      cloneFields[to] = fromItem;\n      cloneFields[from] = toItem;\n      set(form?.store, name, []);\n      setFields(cloneFields);\n    },\n  };\n\n  // 外部设置 fields 优先级最高，可以更改渲染的节点\n  function setListFields(fieldData: any[], callback: Function, originData) {\n    setFields(\n      fieldData.map((_, index) => ({\n        key: (key += 1),\n        name: index,\n        isListField: true,\n      })),\n    );\n    // 添加至队列中 等待下次渲染完成执行对应逻辑\n    fieldsTaskQueueRef.current.push({ callback, fieldData, originData });\n  }\n\n  useEffect(() => {\n    if (!name || !formMapRef) return;\n    formMapRef.current.set(name, formListRef);\n\n    return () => {\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n      formMapRef.current.delete(name);\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [snakeName]);\n\n  useEffect(() => {\n    [...formListMapRef.current.values()].forEach((formItemRef) => {\n      if (!formItemRef.current) return;\n      const { name, isUpdated } = formItemRef.current;\n      if (isUpdated) return; // 内部更新过值则跳过\n\n      const data = get(formListValue, name);\n      formItemRef.current.setField({ value: data, status: 'not' });\n    });\n  }, [formListValue]);\n\n  useEffect(() => {\n    if (!isMounted.current) {\n      isMounted.current = true;\n      return;\n    }\n    // fields 变化通知 watch 事件\n    form?.getInternalHooks?.(HOOK_MARK)?.notifyWatch?.(name);\n\n    // 等待子节点渲染完毕\n    Promise.resolve().then(() => {\n      if (!fieldsTaskQueueRef.current.length) return;\n\n      // fix multiple FormList stuck\n      const currentQueue = fieldsTaskQueueRef.current.pop();\n      const { fieldData, callback, originData } = currentQueue;\n\n      [...formListMapRef.current.values()].forEach((formItemRef) => {\n        if (!formItemRef.current) return;\n\n        const { name: itemName } = formItemRef.current;\n        const data = get(fieldData, itemName);\n        callback(formItemRef, data);\n      });\n\n      // formList 嵌套 formList\n      if (!formMapRef || !formMapRef.current) return;\n      [...formMapRef.current.values()].forEach((formItemRef) => {\n        if (!formItemRef.current) return;\n\n        const { name: itemName, isFormList } = formItemRef.current;\n        if (String(itemName) === String(name) || !isFormList) return;\n        const data = get(originData, itemName);\n        if (data) callback(formItemRef, data);\n      });\n    });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [form, snakeName, fields, formMapRef]);\n\n  useImperativeHandle(\n    formListRef,\n    (): FormItemInstance => ({\n      name,\n      isFormList: true,\n      formListMapRef,\n      getValue() {\n        const formListValue = [];\n        [...formListMapRef.current.values()].forEach((formItemRef) => {\n          if (!formItemRef.current) return;\n\n          const { name, getValue } = formItemRef.current;\n          const fieldValue = calcFieldValue(name, getValue());\n          merge(formListValue, fieldValue);\n        });\n        return formListValue;\n      },\n      validate: (trigger = 'all') => {\n        const resultList = [];\n        const validates = [...formListMapRef.current.values()].map((formItemRef) =>\n          formItemRef?.current?.validate?.(trigger),\n        );\n        return new Promise((resolve) => {\n          Promise.all(validates).then((validateResult) => {\n            validateResult.forEach((result) => {\n              const errorValue = Object.values(result)[0];\n              merge(resultList, errorValue);\n            });\n            const errorItems = validateResult.filter((item) => Object.values(item)[0] !== true);\n            if (errorItems.length) {\n              resolve({ [snakeName]: resultList });\n            } else {\n              resolve({ [snakeName]: true });\n            }\n          });\n        });\n      },\n      // TODO 支持局部更新数据\n      setValue: (fieldData, originalData) => {\n        setListFields(\n          fieldData,\n          (formItemRef, data) => {\n            formItemRef?.current?.setValue?.(data);\n          },\n          originalData,\n        );\n      },\n      setField: (fieldData, originalData) => {\n        const { value, status } = fieldData;\n        setListFields(\n          value,\n          (formItemRef, data) => {\n            formItemRef?.current?.setField?.({ value: data, status });\n          },\n          originalData,\n        );\n      },\n      resetField: (type) => {\n        const resetType = type || resetTypeFromContext;\n\n        if (resetType === 'initial') {\n          setFormListValue(originalInitialData);\n\n          const newFields = originalInitialData.map((data, index) => ({\n            data: { ...data },\n            key: (key += 1),\n            name: index,\n            isListField: true,\n          }));\n          setFields(newFields);\n          set(form?.store, flattenDeep([name]), originalInitialData);\n\n          requestAnimationFrame(() => {\n            [...formListMapRef.current.values()].forEach((formItemRef) => {\n              if (!formItemRef.current) return;\n              const { name: itemName } = formItemRef.current;\n              const itemValue = get(originalInitialData, itemName);\n              if (itemValue !== undefined) {\n                formItemRef.current.setField({ value: itemValue, status: 'not' });\n              }\n            });\n          });\n        } else {\n          // 重置为空\n          [...formListMapRef.current.values()].forEach((formItemRef) => {\n            formItemRef?.current?.resetField?.();\n          });\n\n          fieldsTaskQueueRef.current = [];\n\n          setFormListValue([]);\n          setFields([]);\n          unset(form?.store, flattenDeep([name]));\n        }\n      },\n      setValidateMessage: (fieldData) => {\n        [...formListMapRef.current.values()].forEach((formItemRef) => {\n          if (!formItemRef.current) return;\n\n          const { name } = formItemRef.current;\n          const data = get(fieldData, name);\n\n          formItemRef?.current?.setValidateMessage?.(data);\n        });\n      },\n      resetValidate: () => {\n        [...formListMapRef.current.values()].forEach((formItemRef) => {\n          formItemRef?.current?.resetValidate?.();\n        });\n      },\n    }),\n  );\n\n  if (typeof children !== 'function') {\n    log.error('Form', `FormList's children must be a function!`);\n    return null;\n  }\n\n  return (\n    <FormListContext.Provider value={{ name, rules, formListMapRef, initialData, form }}>\n      {children(fields, operation)}\n    </FormListContext.Provider>\n  );\n};\n\nFormList.displayName = 'FormList';\n\nexport default FormList;\n"],"names":["key","FormList","props","_useFormContext","useFormContext","formMapRef","form","onFormItemValueChange","initialDataFromForm","initialData","resetTypeFromContext","resetType","name","rules","children","originalInitialData","get","storeValue","store","_useState","useState","_useState2","_slicedToArray","formListValue","setFormListValue","_useState3","map","data","index","_objectSpread","isListField","_useState4","fields","setFields","formListMapRef","useRef","Map","formListRef","fieldsTaskQueueRef","snakeName","concat","filter","item","toString","isMounted","useEffect","current","operation","add","defaultValue","insertIndex","cloneFields","_toConsumableArray","length","splice","forEach","field","Object","assign","nextFormListValue","set","flattenDeep","fieldValue","calcFieldValue","requestAnimationFrame","remove","nextFields","Array","isArray","includes","i","_","idx","unset","move","from","to","fromItem","toItem","setListFields","fieldData","callback","originData","push","values","formItemRef","_formItemRef$current","isUpdated","setField","value","status","_form$getInternalHook","_form$getInternalHook2","getInternalHooks","call","HOOK_MARK","notifyWatch","Promise","resolve","then","currentQueue","pop","itemName","_formItemRef$current2","isFormList","String","useImperativeHandle","getValue","_formItemRef$current3","merge","validate","trigger","arguments","undefined","resultList","validates","_formItemRef$current4","_formItemRef$current5","all","validateResult","result","errorValue","errorItems","_defineProperty","setValue","originalData","_formItemRef$current6","_formItemRef$current7","_formItemRef$current8","_formItemRef$current9","resetField","type","newFields","itemValue","_formItemRef$current0","_formItemRef$current1","setValidateMessage","_formItemRef$current10","_formItemRef$current11","resetValidate","_formItemRef$current12","_formItemRef$current13","log","error","React","createElement","FormListContext","Provider","displayName"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAUA,IAAIA,GAAM,GAAA,CAAA,CAAA;AAEV,IAAMC,QAAA,GAAsC,SAAtCA,QAAAA,CAAuCC,KAAU,EAAA;AAC/C,EAAA,IAAAC,eAAA,GAMFC,cAAe,EAAA;IALjBC,UAAA,GAAAF,eAAA,CAAAE,UAAA;IACAC,IAAA,GAAAH,eAAA,CAAAG,IAAA;IACAC,qBAAA,GAAAJ,eAAA,CAAAI,qBAAA;IACaC,mBAAA,GAAAL,eAAA,CAAbM,WAAa;IACFC,oBAAA,GAAAP,eAAA,CAAXQ,SAAW,CAAA;AAEb,EAAA,IAAQC,IAAA,GAA0BV,KAAA,CAA1BU,IAAA;IAAMC,KAAO,GAAaX,KAAA,CAApBW,KAAO;IAAAC,QAAA,GAAaZ,KAAA,CAAbY,QAAA,CAAA;AAErB,EAAA,IAAMC,sBAAsBb,KAAM,CAAAO,WAAA,IAAeO,IAAIR,mBAAqB,EAAAI,IAAI,KAAK,EAAC,CAAA;AACpF,EAAA,IAAMK,UAAa,GAAAD,GAAA,CAAIV,IAAM,KAAA,IAAA,IAANA,IAAM,KAAA,KAAA,CAAA,GAAA,KAAA,CAAA,GAANA,IAAM,CAAAY,KAAA,EAAON,IAAI,CAAA,CAAA;EACxC,IAAMH,cAAcQ,UAAc,KAAA,IAAA,IAAdA,UAAc,KAAdA,KAAAA,CAAAA,GAAAA,UAAc,GAAAF,mBAAA,CAAA;AAElC,EAAA,IAAAI,SAAA,GAA0CC,SAASX,WAAW,CAAA;IAAAY,UAAA,GAAAC,cAAA,CAAAH,SAAA,EAAA,CAAA,CAAA;AAAvDI,IAAAA,aAAA,GAAAF,UAAA,CAAA,CAAA,CAAA;AAAeG,IAAAA,gBAAgB,GAAAH,UAAA,CAAA,CAAA,CAAA,CAAA;EAChC,IAAAI,UAAA,GAAsBL,QAAA,CAA+B,YAAA;AAAA,MAAA,OACzDX,WAAA,CAAYiB,GAAI,CAAA,UAACC,MAAMC,KAAW,EAAA;QAAA,OAAA;AAChCD,UAAAA,IAAA,EAAAE,aAAA,CAAWF,EAAAA,EAAAA,IAAK,CAAA;UAChB3B,KAAMA,GAAO,IAAA,CAAA;AACbY,UAAAA,IAAM,EAAAgB,KAAA;AACNE,UAAAA,WAAa,EAAA,IAAA;SACb,CAAA;AAAA,OAAA,CAAA,CAAA;AAAA,KACJ,CAAA;IAAAC,UAAA,GAAAT,cAAA,CAAAG,UAAA,EAAA,CAAA,CAAA;AAPOO,IAAAA,MAAQ,GAAAD,UAAA,CAAA,CAAA,CAAA;AAAAE,IAAAA,SAAS,GAAAF,UAAA,CAAA,CAAA,CAAA,CAAA;EAQxB,IAAMG,cAAiB,GAAAC,MAAA,gBAAW,IAAAC,GAAA,EAAK,CAAA,CAAA;AACjC,EAAA,IAAAC,WAAA,GAAcF,OAAyB,IAAI,CAAA,CAAA;AAC3C,EAAA,IAAAG,kBAAA,GAAqBH,MAAO,CAAA,EAAE,CAAA,CAAA;AACpC,EAAA,IAAMI,SAAY,GAAA,EACf,CAAAC,MAAA,CAAO5B,IAAI,CAAA,CACX6B,MAAO,CAAA,UAACC,IAAS,EAAA;IAAA,OAAAA,IAAA,KAAS,KAAS,CAAA,CAAA;GAAA,CAAA,CACnCC,QAAS,EAAA,CAAA;AAEN,EAAA,IAAAC,SAAA,GAAYT,OAAO,KAAK,CAAA,CAAA;AAE9BU,EAAAA,SAAA,CACE,YAAA;AAAA,IAAA,OAAM,YAAM;MACVD,SAAA,CAAUE,OAAU,GAAA,KAAA,CAAA;KACtB,CAAA;AAAA,GAAA,EACA,EACF,CAAA,CAAA;AAEA,EAAA,IAAMC,SAAoC,GAAA;AACxCC,IAAAA,GAAA,WAAAA,GAAAA,CAAIC,cAAoBC,WAAsB,EAAA;AACtC,MAAA,IAAAC,WAAA,GAAAC,kBAAA,CAAkBpB,MAAM,CAAA,CAAA;MACxB,IAAAJ,KAAA,GAAQsB,gBAAAA,IAAAA,IAAAA,yBAAAA,cAAeC,WAAY,CAAAE,MAAA,CAAA;AAC7BF,MAAAA,WAAA,CAAAG,MAAA,CAAO1B,OAAO,CAAG,EAAA;QAC3B5B,KAAMA,GAAO,IAAA,CAAA;AACbY,QAAAA,IAAM,EAAAgB,KAAA;AACNE,QAAAA,WAAa,EAAA,IAAA;AACf,OAAC,CAAA,CAAA;AACWqB,MAAAA,WAAA,CAAAI,OAAA,CAAQ,UAACC,KAAA,EAAO5B,MAAU,EAAA;AAAA,QAAA,OAAA6B,MAAA,CAAOC,MAAO,CAAAF,KAAA,EAAO;AAAE5C,UAAAA,IAAA,EAAMgB,MAAAA;AAAM,SAAC,CAAC,CAAA;OAAA,CAAA,CAAA;MAC3EK,SAAA,CAAUkB,WAAW,CAAA,CAAA;AAEf,MAAA,IAAAQ,iBAAA,GAAAP,kBAAA,CAAwB7B,aAAa,CAAA,CAAA;AACvC,MAAA,IAAA,OAAO0B,iBAAiB,WAAa,EAAA;AACvCU,QAAAA,iBAAA,CAAkB/B,KAAS,CAAA,GAAAqB,YAAA,CAAA;QAC3BzB,gBAAA,CAAiBmC,iBAAiB,CAAA,CAAA;AACpC,OAAA;AACAC,MAAAA,GAAA,CAAItD,iBAAAA,2BAAAA,KAAMY,KAAO,EAAA2C,WAAA,CAAY,CAACjD,IAAI,CAAC,GAAG+C,iBAAiB,CAAA,CAAA;AAEjD,MAAA,IAAAG,UAAA,GAAaC,cAAe,CAAAnD,IAAA,EAAM+C,iBAAiB,CAAA,CAAA;AACzDK,MAAAA,qBAAA,CAAsB,YAAM;QACFzD,qBAAA,KAAA,IAAA,IAAAA,qBAAA,KAAAA,KAAAA,CAAAA,IAAAA,qBAAA,CAAAsB,aAAA,CAAA,EAAA,EAAKiC,UAAA,CAAY,CAAA,CAAA;AAC3C,OAAC,CAAA,CAAA;KACH;AACAG,IAAAA,QAAAA,SAAAA,OAAOrC,KAA0B,EAAA;MAC/B,IAAMsC,UAAa,GAAAlC,MAAA,CAChBS,MAAO,CAAA,UAACC,IAAS,EAAA;AACZ,QAAA,IAAAyB,KAAA,CAAMC,QAAQxC,KAAK,CAAA,EAAG,OAAO,CAACA,KAAA,CAAMyC,QAAS,CAAA3B,IAAA,CAAK9B,IAAI,CAAA,CAAA;AAC1D,QAAA,OAAO8B,KAAK9B,IAAS,KAAAgB,KAAA,CAAA;AACvB,OAAC,CACA,CAAAF,GAAA,CAAI,UAAC8B,KAAA,EAAOc,CAAO,EAAA;AAAA,QAAA,OAAAzC,aAAA,CAAAA,aAAA,CAAA,EAAA,EAAK2B,KAAA,CAAA,EAAA,EAAA,EAAA;AAAO5C,UAAAA,IAAM,EAAA0D,CAAAA;AAAA,SAAA,CAAA,CAAA;AAAA,OAAI,CAAA,CAAA;MAC5CrC,SAAA,CAAUiC,UAAU,CAAA,CAAA;MAEpB,IAAMP,oBAAoBpC,aAAc,CAAAkB,MAAA,CAAO,UAAC8B,CAAG,EAAAC,GAAA,EAAA;QAAA,OAAQA,QAAQ5C,KAAK,CAAA;OAAA,CAAA,CAAA;MACxEJ,gBAAA,CAAiBmC,iBAAiB,CAAA,CAAA;AAElCc,MAAAA,KAAA,CAAMnE,iBAAAA,2BAAAA,KAAMY,KAAO,EAAA2C,WAAA,CAAY,CAACjD,IAAM,EAAAgB,KAAK,CAAC,CAAC,CAAA,CAAA;AAEvC,MAAA,IAAAkC,UAAA,GAAaC,cAAe,CAAAnD,IAAA,EAAM+C,iBAAiB,CAAA,CAAA;AACzDK,MAAAA,qBAAA,CAAsB,YAAM;QACFzD,qBAAA,KAAA,IAAA,IAAAA,qBAAA,KAAAA,KAAAA,CAAAA,IAAAA,qBAAA,CAAAsB,aAAA,CAAA,EAAA,EAAKiC,UAAA,CAAY,CAAA,CAAA;AAC3C,OAAC,CAAA,CAAA;KACH;AACAY,IAAAA,IAAA,WAAAA,IAAAA,CAAKC,MAAcC,EAAY,EAAA;AACvB,MAAA,IAAAzB,WAAA,GAAAC,kBAAA,CAAkBpB,MAAM,CAAA,CAAA;MAC9B,IAAM6C,QAAW,GAAAhD,aAAA,CAAA,EAAA,EAAKsB,WAAA,CAAYwB,IAAM,CAAA,CAAA,CAAA;MACxC,IAAMG,MAAS,GAAAjD,aAAA,CAAA,EAAA,EAAKsB,WAAA,CAAYyB,EAAI,CAAA,CAAA,CAAA;AACpCzB,MAAAA,WAAA,CAAYyB,EAAM,CAAA,GAAAC,QAAA,CAAA;AAClB1B,MAAAA,WAAA,CAAYwB,IAAQ,CAAA,GAAAG,MAAA,CAAA;AACpBlB,MAAAA,GAAA,CAAItD,IAAM,KAANA,IAAAA,IAAAA,IAAM,KAANA,KAAAA,CAAAA,GAAAA,KAAAA,CAAAA,GAAAA,IAAM,CAAAY,KAAA,EAAON,IAAM,EAAA,EAAE,CAAA,CAAA;MACzBqB,SAAA,CAAUkB,WAAW,CAAA,CAAA;AACvB,KAAA;GACF,CAAA;AAGS,EAAA,SAAA4B,aAAAA,CAAcC,SAAkB,EAAAC,QAAA,EAAoBC,UAAY,EAAA;IACvEjD,SAAA,CACE+C,SAAU,CAAAtD,GAAA,CAAI,UAAC6C,CAAA,EAAG3C,KAAW,EAAA;MAAA,OAAA;QAC3B5B,KAAMA,GAAO,IAAA,CAAA;AACbY,QAAAA,IAAM,EAAAgB,KAAA;AACNE,QAAAA,WAAa,EAAA,IAAA;OACb,CAAA;AAAA,KAAA,CACJ,CAAA,CAAA;AAEAQ,IAAAA,kBAAA,CAAmBQ,QAAQqC,IAAK,CAAA;AAAEF,MAAAA,QAAU,EAAVA,QAAU;AAAAD,MAAAA,SAAA,EAAAA,SAAA;AAAWE,MAAAA,YAAAA,UAAAA;AAAW,KAAC,CAAA,CAAA;AACrE,GAAA;AAEArC,EAAAA,SAAA,CAAU,YAAM;AACV,IAAA,IAAA,CAACjC,QAAQ,CAACP,UAAA,EAAY,OAAA;IACfA,UAAA,CAAAyC,OAAA,CAAQc,GAAI,CAAAhD,IAAA,EAAMyB,WAAW,CAAA,CAAA;AAExC,IAAA,OAAO,YAAM;AAEAhC,MAAAA,UAAA,CAAAyC,OAAA,WAAelC,IAAI,CAAA,CAAA;KAChC,CAAA;AAEF,GAAA,EAAG,CAAC2B,SAAS,CAAC,CAAA,CAAA;AAEdM,EAAAA,SAAA,CAAU,YAAM;AACbO,IAAAA,kBAAA,CAAGlB,eAAeY,OAAQ,CAAAsC,MAAA,EAAQ,CAAE7B,CAAAA,OAAA,CAAQ,UAAC8B,WAAgB,EAAA;AAC5D,MAAA,IAAI,CAACA,WAAY,CAAAvC,OAAA,EAAS,OAAA;AAC1B,MAAA,IAAAwC,oBAAA,GAA4BD,WAAY,CAAAvC,OAAA;QAAhClC,KAAM,GAAA0E,oBAAA,CAAN1E,IAAA;QAAM2E,SAAA,GAAAD,oBAAA,CAAAC,SAAA,CAAA;AACV,MAAA,IAAAA,SAAA,EAAW,OAAA;AAET,MAAA,IAAA5D,IAAA,GAAOX,GAAI,CAAAO,aAAA,EAAeX,KAAI,CAAA,CAAA;AACpCyE,MAAAA,WAAA,CAAYvC,QAAQ0C,QAAS,CAAA;AAAEC,QAAAA,OAAO9D,IAAM;AAAA+D,QAAAA,MAAA,EAAQ,KAAA;AAAM,OAAC,CAAA,CAAA;AAC7D,KAAC,CAAA,CAAA;AACH,GAAA,EAAG,CAACnE,aAAa,CAAC,CAAA,CAAA;AAElBsB,EAAAA,SAAA,CAAU,YAAM;IAAA,IAAA8C,qBAAA,EAAAC,sBAAA,CAAA;AACV,IAAA,IAAA,CAAChD,UAAUE,OAAS,EAAA;MACtBF,SAAA,CAAUE,OAAU,GAAA,IAAA,CAAA;AACpB,MAAA,OAAA;AACF,KAAA;AAEAxC,IAAAA,IAAA,aAAAA,IAAA,KAAA,KAAA,CAAA,IAAA,CAAAqF,qBAAA,GAAArF,IAAA,CAAMuF,gBAAmB,MAAAF,IAAAA,IAAAA,qBAAA,gBAAAA,qBAAA,GAAzBA,qBAAA,CAAAG,IAAA,CAAAxF,IAAA,EAAyByF,SAAS,CAAG,cAAAJ,qBAAA,KAAA,KAAA,CAAA,IAAA,CAAAC,sBAAA,GAArCD,qBAAA,CAAqCK,WAAA,MAAA,IAAA,IAAAJ,sBAAA,KAAA,KAAA,CAAA,IAArCA,sBAAA,CAAAE,IAAA,CAAAH,qBAAA,EAAmD/E,IAAI,CAAA,CAAA;AAG/CqF,IAAAA,OAAA,CAAAC,OAAA,EAAU,CAAAC,IAAA,CAAK,YAAM;AACvB,MAAA,IAAA,CAAC7D,mBAAmBQ,OAAQ,CAAAO,MAAA,EAAQ,OAAA;MAGlC,IAAA+C,YAAA,GAAe9D,kBAAmB,CAAAQ,OAAA,CAAQuD,GAAI,EAAA,CAAA;AACpD,MAAA,IAAQrB,SAAA,GAAoCoB,YAAA,CAApCpB,SAAA;QAAWC,QAAU,GAAemB,YAAA,CAAzBnB,QAAU;QAAAC,UAAA,GAAekB,YAAA,CAAflB,UAAA,CAAA;AAE5B9B,MAAAA,kBAAA,CAAGlB,eAAeY,OAAQ,CAAAsC,MAAA,EAAQ,CAAE7B,CAAAA,OAAA,CAAQ,UAAC8B,WAAgB,EAAA;AAC5D,QAAA,IAAI,CAACA,WAAY,CAAAvC,OAAA,EAAS,OAAA;AAE1B,QAAA,IAAcwD,QAAS,GAAIjB,WAAY,CAAAvC,OAAA,CAA/BlC,IAAA,CAAA;AACF,QAAA,IAAAe,IAAA,GAAOX,GAAI,CAAAgE,SAAA,EAAWsB,QAAQ,CAAA,CAAA;AACpCrB,QAAAA,QAAA,CAASI,aAAa1D,IAAI,CAAA,CAAA;AAC5B,OAAC,CAAA,CAAA;AAGG,MAAA,IAAA,CAACtB,UAAc,IAAA,CAACA,UAAW,CAAAyC,OAAA,EAAS,OAAA;AACvCM,MAAAA,kBAAA,CAAG/C,WAAWyC,OAAQ,CAAAsC,MAAA,EAAQ,CAAE7B,CAAAA,OAAA,CAAQ,UAAC8B,WAAgB,EAAA;AACxD,QAAA,IAAI,CAACA,WAAY,CAAAvC,OAAA,EAAS,OAAA;AAE1B,QAAA,IAAAyD,qBAAA,GAAuClB,WAAY,CAAAvC,OAAA;UAArCwD,QAAU,GAAAC,qBAAA,CAAhB3F,IAAA;UAAgB4F,UAAA,GAAAD,qBAAA,CAAAC,UAAA,CAAA;AACxB,QAAA,IAAIC,OAAOH,QAAQ,CAAA,KAAMG,MAAO,CAAA7F,IAAI,KAAK,CAAC4F,UAAA,EAAY,OAAA;AAChD,QAAA,IAAA7E,IAAA,GAAOX,GAAI,CAAAkE,UAAA,EAAYoB,QAAQ,CAAA,CAAA;AACjC,QAAA,IAAA3E,IAAA,EAAMsD,QAAA,CAASI,aAAa1D,IAAI,CAAA,CAAA;AACtC,OAAC,CAAA,CAAA;AACH,KAAC,CAAA,CAAA;KAEA,CAACrB,IAAA,EAAMiC,SAAW,EAAAP,MAAA,EAAQ3B,UAAU,CAAC,CAAA,CAAA;EAExCqG,mBAAA,CACErE,WAAA,EACA,YAAA;IAAA,OAAyB;AACvBzB,MAAAA,IAAA,EAAAA,IAAA;AACA4F,MAAAA,UAAY,EAAA,IAAA;AACZtE,MAAAA,cAAA,EAAAA,cAAA;MACAyE,QAAW,EAAA,SAAXA,QAAWA,GAAA;QACT,IAAMpF,iBAAgB,EAAC,CAAA;AACtB6B,QAAAA,kBAAA,CAAGlB,eAAeY,OAAQ,CAAAsC,MAAA,EAAQ,CAAE7B,CAAAA,OAAA,CAAQ,UAAC8B,WAAgB,EAAA;AAC5D,UAAA,IAAI,CAACA,WAAY,CAAAvC,OAAA,EAAS,OAAA;AAE1B,UAAA,IAAA8D,qBAAA,GAA2BvB,WAAY,CAAAvC,OAAA;YAA/BlC,KAAM,GAAAgG,qBAAA,CAANhG,IAAA;YAAM+F,QAAA,GAAAC,qBAAA,CAAAD,QAAA,CAAA;UACd,IAAM7C,UAAa,GAAAC,cAAA,CAAenD,KAAM,EAAA+F,QAAA,EAAU,CAAA,CAAA;AAClDE,UAAAA,KAAA,CAAMtF,gBAAeuC,UAAU,CAAA,CAAA;AACjC,SAAC,CAAA,CAAA;AACMvC,QAAAA,OAAAA,cAAAA,CAAAA;OACT;AACAuF,MAAAA,QAAA,EAAU,SAAVA,QAAAA,GAA+B;AAAA,QAAA,IAApBC,OAAA,GAAAC,SAAA,CAAA3D,MAAA,GAAA,CAAA,IAAA2D,SAAA,CAAA,CAAA,CAAA,KAAAC,SAAA,GAAAD,SAAA,CAAA,CAAA,CAAA,GAAU,KAAU,CAAA;QAC7B,IAAME,aAAa,EAAC,CAAA;AACpB,QAAA,IAAMC,YAAY/D,kBAAA,CAAIlB,eAAeY,OAAQ,CAAAsC,MAAA,EAAQ,CAAA,CAAE1D,GAAA,CAAI,UAAC2D,WAAA,EAAA;UAAA,IAAA+B,qBAAA,EAAAC,qBAAA,CAAA;UAAA,OAC1DhC,WAAa,KAAbA,IAAAA,IAAAA,WAAa,KAAA+B,KAAAA,CAAAA,IAAAA,CAAAA,qBAAA,GAAb/B,WAAa,CAAAvC,OAAA,MAAAsE,IAAAA,IAAAA,qBAAA,KAAAC,KAAAA,CAAAA,IAAAA,CAAAA,qBAAA,GAAbD,qBAAA,CAAsBN,gDAAtBO,KAAAA,CAAAA,GAAAA,KAAAA,CAAAA,GAAAA,qBAAA,CAAAvB,IAAA,CAAAsB,qBAAA,EAAiCL,OAAO,CAAA,CAAA;AAAA,SAC1C,CAAA,CAAA;AACO,QAAA,OAAA,IAAId,OAAQ,CAAA,UAACC,OAAY,EAAA;UAC9BD,OAAA,CAAQqB,GAAI,CAAAH,SAAS,CAAE,CAAAhB,IAAA,CAAK,UAACoB,cAAmB,EAAA;AAC/BA,YAAAA,cAAA,CAAAhE,OAAA,CAAQ,UAACiE,MAAW,EAAA;cACjC,IAAMC,UAAa,GAAAhE,MAAA,CAAO2B,MAAO,CAAAoC,MAAM,CAAE,CAAA,CAAA,CAAA,CAAA;AACzCX,cAAAA,KAAA,CAAMK,YAAYO,UAAU,CAAA,CAAA;AAC9B,aAAC,CAAA,CAAA;AACK,YAAA,IAAAC,UAAA,GAAaH,cAAe,CAAA9E,MAAA,CAAO,UAACC,IAAA,EAAA;cAAA,OAASe,OAAO2B,MAAO,CAAA1C,IAAI,CAAE,CAAA,CAAA,CAAA,KAAO,IAAI,CAAA;aAAA,CAAA,CAAA;YAClF,IAAIgF,WAAWrE,MAAQ,EAAA;AACrB6C,cAAAA,OAAA,CAAAyB,eAAA,CAAA,EAAA,EAAWpF,SAAY,EAAA2E,UAAA,CAAY,CAAA,CAAA;AACrC,aAAO,MAAA;AACLhB,cAAAA,OAAA,CAAAyB,eAAA,CAAA,EAAA,EAAWpF,SAAY,EAAA,IAAA,CAAM,CAAA,CAAA;AAC/B,aAAA;AACF,WAAC,CAAA,CAAA;AACH,SAAC,CAAA,CAAA;OACH;AAEAqF,MAAAA,QAAA,EAAU,SAAVA,QAAAA,CAAW5C,SAAA,EAAW6C,YAAiB,EAAA;AACrC9C,QAAAA,aAAA,CACEC,SAAA,EACA,UAACK,aAAa1D,IAAS,EAAA;UAAA,IAAAmG,qBAAA,EAAAC,qBAAA,CAAA;UACR1C,WAAA,KAAA,IAAA,IAAAA,WAAA,KAAA,KAAA,CAAA,IAAA,CAAAyC,qBAAA,GAAAzC,WAAA,CAAAvC,OAAA,MAAA,IAAA,IAAAgF,qBAAA,KAAA,KAAA,CAAA,IAAA,CAAAC,qBAAA,GAAAD,qBAAA,CAASF,gDAATG,KAAAA,CAAAA,IAAAA,qBAAA,CAAAjC,IAAA,CAAAgC,qBAAA,EAAoBnG,IAAI,CAAA,CAAA;SACvC,EACAkG,YACF,CAAA,CAAA;OACF;AACArC,MAAAA,QAAA,EAAU,SAAVA,QAAAA,CAAWR,SAAA,EAAW6C,YAAiB,EAAA;AAC/B,QAAA,IAAEpC,KAAO,GAAWT,SAAA,CAAlBS,KAAO;UAAAC,MAAA,GAAWV,SAAA,CAAXU,MAAA,CAAA;AACfX,QAAAA,aAAA,CACEU,KAAA,EACA,UAACJ,aAAa1D,IAAS,EAAA;UAAA,IAAAqG,qBAAA,EAAAC,qBAAA,CAAA;UACrB5C,WAAA,KAAA,IAAA,IAAAA,WAAA,KAAA,KAAA,CAAA,IAAA,CAAA2C,qBAAA,GAAA3C,WAAA,CAAavC,kFAAbkF,qBAAA,CAAsBxC,QAAW,MAAA,IAAA,IAAAyC,qBAAA,KAAA,KAAA,CAAA,IAAjCA,qBAAA,CAAAnC,IAAA,CAAAkC,qBAAA,EAAiC;AAAEvC,YAAAA,KAAO,EAAA9D,IAAA;AAAM+D,YAAAA,QAAAA,MAAAA;AAAO,WAAC,CAAA,CAAA;SAC1D,EACAmC,YACF,CAAA,CAAA;OACF;AACAK,MAAAA,UAAA,EAAY,SAAZA,UAAAA,CAAaC,IAAS,EAAA;AACpB,QAAA,IAAMxH,YAAYwH,IAAQ,IAAAzH,oBAAA,CAAA;QAE1B,IAAIC,cAAc,SAAW,EAAA;UAC3Ba,gBAAA,CAAiBT,mBAAmB,CAAA,CAAA;UAEpC,IAAMqH,SAAY,GAAArH,mBAAA,CAAoBW,GAAI,CAAA,UAACC,MAAMC,KAAW,EAAA;YAAA,OAAA;AAC1DD,cAAAA,IAAA,EAAAE,aAAA,CAAWF,EAAAA,EAAAA,IAAK,CAAA;cAChB3B,KAAMA,GAAO,IAAA,CAAA;AACbY,cAAAA,IAAM,EAAAgB,KAAA;AACNE,cAAAA,WAAa,EAAA,IAAA;aACb,CAAA;AAAA,WAAA,CAAA,CAAA;UACFG,SAAA,CAAUmG,SAAS,CAAA,CAAA;AACnBxE,UAAAA,GAAA,CAAItD,iBAAAA,2BAAAA,KAAMY,KAAO,EAAA2C,WAAA,CAAY,CAACjD,IAAI,CAAC,GAAGG,mBAAmB,CAAA,CAAA;AAEzDiD,UAAAA,qBAAA,CAAsB,YAAM;AACzBZ,YAAAA,kBAAA,CAAGlB,eAAeY,OAAQ,CAAAsC,MAAA,EAAQ,CAAE7B,CAAAA,OAAA,CAAQ,UAAC8B,WAAgB,EAAA;AAC5D,cAAA,IAAI,CAACA,WAAY,CAAAvC,OAAA,EAAS,OAAA;AAC1B,cAAA,IAAcwD,QAAS,GAAIjB,WAAY,CAAAvC,OAAA,CAA/BlC,IAAA,CAAA;AACF,cAAA,IAAAyH,SAAA,GAAYrH,GAAI,CAAAD,mBAAA,EAAqBuF,QAAQ,CAAA,CAAA;AACnD,cAAA,IAAI+B,cAAc,KAAW,CAAA,EAAA;AAC3BhD,gBAAAA,WAAA,CAAYvC,QAAQ0C,QAAS,CAAA;AAAEC,kBAAAA,OAAO4C,SAAW;AAAA3C,kBAAAA,MAAA,EAAQ,KAAA;AAAM,iBAAC,CAAA,CAAA;AAClE,eAAA;AACF,aAAC,CAAA,CAAA;AACH,WAAC,CAAA,CAAA;AACH,SAAO,MAAA;AAEJtC,UAAAA,kBAAA,CAAGlB,eAAeY,OAAQ,CAAAsC,MAAA,EAAQ,CAAE7B,CAAAA,OAAA,CAAQ,UAAC8B,WAAgB,EAAA;YAAA,IAAAiD,qBAAA,EAAAC,qBAAA,CAAA;YAC5DlD,WAAA,KAAA,IAAA,IAAAA,WAAA,KAAA,KAAA,CAAA,IAAA,CAAAiD,qBAAA,GAAAjD,WAAA,CAAavC,kFAAbwF,qBAAA,CAAsBJ,UAAa,MAAA,IAAA,IAAAK,qBAAA,KAAA,KAAA,CAAA,IAAnCA,qBAAA,CAAAzC,IAAA,CAAAwC,qBAAmC,CAAA,CAAA;AACrC,WAAC,CAAA,CAAA;UAEDhG,kBAAA,CAAmBQ,UAAU,EAAC,CAAA;UAE9BtB,gBAAA,CAAiB,EAAE,CAAA,CAAA;UACnBS,SAAA,CAAU,EAAE,CAAA,CAAA;AACZwC,UAAAA,KAAA,CAAMnE,SAAAA,IAAAA,IAAAA,2BAAAA,KAAMY,KAAO,EAAA2C,WAAA,CAAY,CAACjD,IAAI,CAAC,CAAC,CAAA,CAAA;AACxC,SAAA;OACF;AACA4H,MAAAA,kBAAA,EAAoB,SAApBA,kBAAAA,CAAqBxD,SAAc,EAAA;AAChC5B,QAAAA,kBAAA,CAAGlB,eAAeY,OAAQ,CAAAsC,MAAA,EAAQ,CAAE7B,CAAAA,OAAA,CAAQ,UAAC8B,WAAgB,EAAA;UAAA,IAAAoD,sBAAA,EAAAC,sBAAA,CAAA;AAC5D,UAAA,IAAI,CAACrD,WAAY,CAAAvC,OAAA,EAAS,OAAA;AAE1B,UAAA,IAAQlC,KAAK,GAAIyE,WAAY,CAAAvC,OAAA,CAArBlC,IAAA,CAAA;AACF,UAAA,IAAAe,IAAA,GAAOX,GAAI,CAAAgE,SAAA,EAAWpE,KAAI,CAAA,CAAA;UAEnByE,WAAA,KAAA,IAAA,IAAAA,WAAA,KAAA,KAAA,CAAA,IAAA,CAAAoD,sBAAA,GAAApD,WAAA,CAAAvC,OAAA,MAAA,IAAA,IAAA2F,sBAAA,KAAA,KAAA,CAAA,IAAA,CAAAC,sBAAA,GAAAD,sBAAA,CAASD,2DAATE,KAAAA,CAAAA,IAAAA,sBAAA,CAAA5C,IAAA,CAAA2C,sBAAA,EAA8B9G,IAAI,CAAA,CAAA;AACjD,SAAC,CAAA,CAAA;OACH;AACAgH,MAAAA,eAAe,SAAfA,gBAAqB;AAClBvF,QAAAA,kBAAA,CAAGlB,eAAeY,OAAQ,CAAAsC,MAAA,EAAQ,CAAE7B,CAAAA,OAAA,CAAQ,UAAC8B,WAAgB,EAAA;UAAA,IAAAuD,sBAAA,EAAAC,sBAAA,CAAA;UAC5DxD,WAAA,KAAA,IAAA,IAAAA,WAAA,KAAA,KAAA,CAAA,IAAA,CAAAuD,sBAAA,GAAAvD,WAAA,CAAavC,oFAAb8F,sBAAA,CAAsBD,aAAgB,MAAA,IAAA,IAAAE,sBAAA,KAAA,KAAA,CAAA,IAAtCA,sBAAA,CAAA/C,IAAA,CAAA8C,sBAAsC,CAAA,CAAA;AACxC,SAAC,CAAA,CAAA;AACH,OAAA;KACF,CAAA;AAAA,GACF,CAAA,CAAA;AAEI,EAAA,IAAA,OAAO9H,aAAa,UAAY,EAAA;AAC9BgI,IAAAA,GAAA,CAAAC,KAAA,CAAM,iDAAiD,CAAA,CAAA;AACpD,IAAA,OAAA,IAAA,CAAA;AACT,GAAA;EAGE,sBAAAC,KAAA,CAAAC,aAAA,CAACC,gBAAgBC,QAAhB,EAAA;AAAyB1D,IAAAA,OAAO;AAAE7E,MAAAA,IAAA,EAAAA,IAAA;AAAMC,MAAAA,KAAO,EAAPA,KAAO;AAAAqB,MAAAA,cAAA,EAAAA,cAAA;AAAgBzB,MAAAA,aAAAA;AAAaH,MAAAA,IAAK,EAALA,IAAAA;AAAK,KAAA;AAC/E,GAAA,EAAAQ,QAAA,CAASkB,MAAQ,EAAAe,SAAS,CAC7B,CAAA,CAAA;AAEJ,EAAA;AAEA9C,QAAA,CAASmJ,WAAc,GAAA,UAAA;;;;"}