{"version":3,"file":"useTreeVirtualScroll.js","sources":["../../../../components/tree/hooks/useTreeVirtualScroll.ts"],"sourcesContent":["import { useEffect, useMemo } from 'react';\n\nimport TreeNode from '@tdesign/common-js/tree-v1/tree-node';\nimport useEventCallback from '../../hooks/useEventCallback';\nimport useVirtualScroll from '../../hooks/useVirtualScroll';\n\nimport type { TScroll } from '../../common';\nimport type { TdTreeProps } from '../type';\n\nexport default function useTreeVirtualScroll({\n  treeRef,\n  scroll,\n  data = [],\n  onScroll,\n}: {\n  data: TreeNode[];\n  scroll: TScroll;\n  treeRef: React.MutableRefObject<HTMLElement>;\n  onScroll: TdTreeProps['onScroll'];\n}) {\n  const scrollThreshold = scroll?.threshold || 100;\n  const scrollType = scroll?.type;\n\n  const enableVirtual = useMemo(() => scrollType === 'virtual', [scrollType]);\n  const isVirtual = useMemo(\n    () => enableVirtual && data?.length > scrollThreshold,\n    [enableVirtual, scrollThreshold, data],\n  );\n\n  const scrollParams = useMemo(\n    () =>\n      ({\n        type: 'virtual',\n        isFixedRowHeight: scroll?.isFixedRowHeight || false, // expand and collapse operation make height of tree item different\n        rowHeight: scroll?.rowHeight || 34,\n        bufferSize: scroll?.bufferSize || 20,\n        threshold: scrollThreshold,\n      } as const),\n    [scroll, scrollThreshold],\n  );\n\n  const {\n    visibleData = null,\n    handleScroll: handleVirtualScroll = null,\n    scrollHeight = null,\n    translateY = null,\n    handleRowMounted = null,\n    scrollToElement,\n  } = useVirtualScroll(treeRef, {\n    enable: enableVirtual,\n    data: data || [],\n    scroll: scrollParams,\n  });\n\n  let lastScrollY = -1;\n  const onInnerVirtualScroll = useEventCallback((e: WheelEvent) => {\n    onScroll?.({ e });\n    if (!isVirtual) {\n      return;\n    }\n    const target = e.target as HTMLElement;\n    const top = target.scrollTop;\n    if (lastScrollY !== top) {\n      handleVirtualScroll();\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n    } else {\n      lastScrollY = -1;\n    }\n    lastScrollY = top;\n  });\n\n  useEffect(() => {\n    const treeList = treeRef?.current;\n    treeList?.addEventListener?.('scroll', onInnerVirtualScroll);\n\n    return () => {\n      // 卸载时取消监听\n      treeList?.removeEventListener?.('scroll', onInnerVirtualScroll);\n    };\n  }, [treeRef, onInnerVirtualScroll]);\n\n  const cursorStyle = {\n    position: 'absolute',\n    width: '1px',\n    height: '1px',\n    transition: 'transform 0.2s',\n    transform: `translate(0, ${scrollHeight}px)`,\n    MsTransform: `translate(0, ${scrollHeight}px)`,\n    MozTransform: `translate(0, ${scrollHeight}px)`,\n    WebkitTransform: `translate(0, ${scrollHeight}px)`,\n  } as React.CSSProperties;\n\n  const treeNodeStyle = {\n    transform: `translate(0, ${translateY}px)`,\n    MsTransform: `translate(0, ${translateY}px)`,\n    MozTransform: `translate(0, ${translateY}px)`,\n    WebkitTransform: `translate(0, ${translateY}px)`,\n  } as React.CSSProperties;\n\n  return {\n    scrollHeight,\n    translateY,\n    visibleData,\n    handleRowMounted,\n    isVirtual,\n    cursorStyle,\n    treeNodeStyle,\n    scrollToElement,\n  };\n}\n"],"names":["useTreeVirtualScroll","_ref","treeRef","scroll","_ref$data","data","onScroll","scrollThreshold","threshold","scrollType","type","enableVirtual","useMemo","isVirtual","length","scrollParams","isFixedRowHeight","rowHeight","bufferSize","_useVirtualScroll","useVirtualScroll","enable","_useVirtualScroll$vis","visibleData","_useVirtualScroll$han","handleScroll","handleVirtualScroll","_useVirtualScroll$scr","scrollHeight","_useVirtualScroll$tra","translateY","_useVirtualScroll$han2","handleRowMounted","scrollToElement","lastScrollY","onInnerVirtualScroll","useEventCallback","e","target","top","scrollTop","useEffect","_treeList$addEventLis","treeList","current","addEventListener","call","_treeList$removeEvent","removeEventListener","cursorStyle","position","width","height","transition","transform","MsTransform","MozTransform","WebkitTransform","treeNodeStyle"],"mappings":"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"}