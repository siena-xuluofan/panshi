{"version":3,"file":"useMultiple.js","sources":["../../../components/select-input/useMultiple.tsx"],"sourcesContent":["import React, { useRef } from 'react';\n\nimport classNames from 'classnames';\nimport { isObject } from 'lodash-es';\n\nimport useConfig from '../hooks/useConfig';\nimport useControlled from '../hooks/useControlled';\nimport TagInput, { type TagInputValue } from '../tag-input';\n\nimport type { StyledProps } from '../common';\nimport type { InputRef } from '../input';\nimport type { SelectInputCommonProperties } from './interface';\nimport type { SelectInputChangeContext, SelectInputKeys, SelectInputValue, TdSelectInputProps } from './type';\n\nexport interface RenderSelectMultipleParams {\n  commonInputProps: SelectInputCommonProperties;\n  popupVisible: boolean;\n  allowInput: boolean;\n  onInnerClear: (context: { e: React.MouseEvent<SVGElement> }) => void;\n  onInnerBlur?: (context: { e: React.FocusEvent<HTMLInputElement> }) => void;\n}\n\nconst DEFAULT_KEYS = {\n  label: 'label',\n  key: 'key',\n  children: 'children',\n};\n\nexport interface SelectInputProps extends TdSelectInputProps, StyledProps {\n  options?: any[]; // 参数穿透options, 给SelectInput/SelectInput 自定义选中项呈现的内容和多选状态下设置折叠项内容\n}\n\nexport default function useMultiple(props: SelectInputProps) {\n  const { value } = props;\n  const { classPrefix } = useConfig();\n\n  const [tInputValue, setTInputValue] = useControlled(props, 'inputValue', props.onInputChange);\n\n  const tagInputRef = useRef<InputRef>(null);\n  const blurTimeoutRef = useRef(null);\n\n  const iKeys: SelectInputKeys = { ...DEFAULT_KEYS, ...props.keys };\n\n  const getTags = () => {\n    if (!(value instanceof Array)) {\n      if (['', null, undefined].includes(value as any)) return [];\n      return isObject(value) ? [value[iKeys.label]] : [value];\n    }\n    return value.map((item: SelectInputValue) => (isObject(item) ? item[iKeys.label] : item));\n  };\n  const tags = getTags();\n  const tPlaceholder = !tags || !tags.length ? props.placeholder : '';\n\n  const onTagInputChange = (val: TagInputValue, context: SelectInputChangeContext) => {\n    // 避免触发浮层的显示或隐藏\n    if (context.trigger === 'tag-remove') {\n      context.e?.stopPropagation();\n    }\n    props.onTagChange?.(val, context);\n  };\n\n  const renderSelectMultiple = (p: RenderSelectMultipleParams) => {\n    const handleBlur = (value: SelectInputValue, context: { e: React.FocusEvent<HTMLInputElement> }) => {\n      if (blurTimeoutRef.current) {\n        clearTimeout(blurTimeoutRef.current);\n      }\n      // 强制把 popupVisible 设置为 false 时，点击 input，会出现 blur -> focus 的情况，因此忽略前面短暂的 blur 事件\n      blurTimeoutRef.current = setTimeout(() => {\n        if (blurTimeoutRef.current) {\n          if (!p.popupVisible) {\n            p.onInnerBlur(context);\n          } else if (!props.panel) {\n            props.onBlur?.(value, { e: context.e, inputValue: tInputValue, tagInputValue: tags });\n          }\n        }\n        blurTimeoutRef.current = null;\n      }, 150);\n    };\n\n    const handleFocus = (\n      val: TagInputValue,\n      context: { e: React.FocusEvent<HTMLInputElement>; inputValue: string },\n    ) => {\n      if (blurTimeoutRef.current) {\n        clearTimeout(blurTimeoutRef.current);\n        blurTimeoutRef.current = null;\n      }\n      props.onFocus?.(props.value, { ...context, tagInputValue: val });\n    };\n\n    return (\n      <TagInput\n        ref={tagInputRef}\n        {...p.commonInputProps}\n        autoWidth={props.autoWidth}\n        readonly={props.readonly}\n        minCollapsedNum={props.minCollapsedNum}\n        collapsedItems={props.collapsedItems}\n        tag={props.tag}\n        valueDisplay={props.valueDisplay}\n        placeholder={tPlaceholder}\n        options={props.options}\n        value={tags}\n        inputValue={p.popupVisible && p.allowInput ? tInputValue : ''}\n        onChange={onTagInputChange}\n        onInputChange={(val, context) => {\n          // 筛选器统一特性：筛选器按下回车时不清空输入框\n          if (context?.trigger === 'enter' || context?.trigger === 'blur') return;\n          setTInputValue(val, { trigger: context.trigger, e: context.e });\n        }}\n        tagProps={props.tagProps}\n        onClear={p.onInnerClear}\n        // [Important Info]: SelectInput.blur is not equal to TagInput, example: click popup panel\n        onFocus={handleFocus}\n        onBlur={handleBlur}\n        {...props.tagInputProps}\n        inputProps={{\n          ...props.inputProps,\n          readonly: !props.allowInput || props.readonly,\n          inputClass: classNames(props.tagInputProps?.className, {\n            [`${classPrefix}-input--focused`]: p.popupVisible,\n            [`${classPrefix}-is-focused`]: p.popupVisible,\n          }),\n        }}\n      />\n    );\n  };\n\n  return {\n    tags,\n    tPlaceholder,\n    tagInputRef,\n    multipleInputValue: tInputValue,\n    renderSelectMultiple,\n  };\n}\n"],"names":["DEFAULT_KEYS","label","key","children","useMultiple","props","value","_useConfig","useConfig","classPrefix","_useControlled","useControlled","onInputChange","_useControlled2","_slicedToArray","tInputValue","setTInputValue","tagInputRef","useRef","blurTimeoutRef","iKeys","keys","getTags","Array","includes","isObject","map","item","tags","tPlaceholder","length","placeholder","onTagInputChange","val","context","_props$onTagChange","trigger","_context$e","e","stopPropagation","onTagChange","call","renderSelectMultiple","p","_props$tagInputProps","handleBlur","current","clearTimeout","setTimeout","popupVisible","onInnerBlur","panel","_props$onBlur","onBlur","inputValue","tagInputValue","handleFocus","_props$onFocus","onFocus","_objectSpread","React","createElement","TagInput","ref","commonInputProps","autoWidth","readonly","minCollapsedNum","collapsedItems","tag","valueDisplay","options","allowInput","onChange","tagProps","onClear","onInnerClear","tagInputProps","inputProps","inputClass","classNames","className","_defineProperty","concat","multipleInputValue"],"mappings":"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"}