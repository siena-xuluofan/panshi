{"version":3,"file":"Affix.js","sources":["../../../components/affix/Affix.tsx"],"sourcesContent":["import React, { useEffect, forwardRef, useCallback, useImperativeHandle, useRef } from 'react';\nimport { isFunction } from 'lodash-es';\nimport { StyledProps, ScrollContainerElement } from '../common';\nimport { TdAffixProps } from './type';\nimport useConfig from '../hooks/useConfig';\nimport { affixDefaultProps } from './defaultProps';\nimport useDefaultProps from '../hooks/useDefaultProps';\nimport { getScrollContainer } from '../_util/scroll';\n\nexport interface AffixProps extends TdAffixProps, StyledProps {}\n\nexport interface AffixRef {\n  handleScroll: () => void;\n}\n\nconst Affix = forwardRef<AffixRef, AffixProps>((props, ref) => {\n  const { children, content, zIndex, container, offsetBottom, offsetTop, className, style, onFixedChange } =\n    useDefaultProps(props, affixDefaultProps);\n\n  const { classPrefix } = useConfig();\n\n  const affixRef = useRef<HTMLDivElement>(null);\n  const affixWrapRef = useRef<HTMLDivElement>(null);\n  const placeholderEL = useRef<HTMLElement>(null);\n  const scrollContainer = useRef<ScrollContainerElement>(null);\n\n  const ticking = useRef(false);\n\n  // 这里是通过控制 wrap 的 border-top 到浏览器顶部距离和 offsetTop 比较\n  const handleScroll = useCallback(() => {\n    if (!ticking.current) {\n      window.requestAnimationFrame(() => {\n        // top = 节点到页面顶部的距离，包含 scroll 中的高度\n        const {\n          top: wrapToTop = 0,\n          width: wrapWidth = 0,\n          height: wrapHeight = 0,\n        } = affixWrapRef.current?.getBoundingClientRect() ?? { top: 0 };\n\n        // 容器到页面顶部的距离, windows 为0\n        let containerToTop = 0;\n        if (scrollContainer.current instanceof HTMLElement) {\n          containerToTop = scrollContainer.current.getBoundingClientRect().top;\n        }\n\n        const calcTop = wrapToTop - containerToTop; // 节点顶部到 container 顶部的距离\n        const containerHeight =\n          scrollContainer.current?.[scrollContainer.current instanceof Window ? 'innerHeight' : 'clientHeight'] -\n          wrapHeight;\n        const calcBottom = containerToTop + containerHeight - (offsetBottom ?? 0); // 计算 bottom 相对应的 top 值\n\n        let fixedTop: number | false;\n        if (calcTop <= offsetTop) {\n          // top 的触发\n          fixedTop = containerToTop + offsetTop;\n        } else if (wrapToTop >= calcBottom) {\n          // bottom 的触发\n          fixedTop = calcBottom;\n        } else {\n          fixedTop = false;\n        }\n\n        if (affixRef.current) {\n          const affixed = fixedTop !== false;\n          let placeholderStatus = affixWrapRef.current.contains(placeholderEL.current);\n          const prePlaceholderStatus = placeholderStatus;\n\n          if (affixed) {\n            // 定位\n            affixRef.current.className = `${classPrefix}-affix`;\n            affixRef.current.style.top = `${fixedTop}px`;\n            affixRef.current.style.width = `${wrapWidth}px`;\n            affixRef.current.style.height = `${wrapHeight}px`;\n\n            if (zIndex) {\n              affixRef.current.style.zIndex = `${zIndex}`;\n            }\n\n            // 插入占位节点\n            if (!placeholderStatus) {\n              placeholderEL.current.style.width = `${wrapWidth}px`;\n              placeholderEL.current.style.height = `${wrapHeight}px`;\n              affixWrapRef.current.appendChild(placeholderEL.current);\n              placeholderStatus = true;\n            }\n          } else {\n            affixRef.current.removeAttribute('class');\n            affixRef.current.removeAttribute('style');\n\n            // 删除占位节点\n            if (placeholderStatus) {\n              placeholderEL.current.remove();\n              placeholderStatus = false;\n            }\n          }\n          if (prePlaceholderStatus !== placeholderStatus && isFunction(onFixedChange)) {\n            onFixedChange(affixed, { top: +fixedTop });\n          }\n        }\n\n        ticking.current = false;\n      });\n    }\n    ticking.current = true;\n  }, [classPrefix, offsetBottom, offsetTop, onFixedChange, zIndex]);\n\n  useImperativeHandle(ref, () => ({\n    handleScroll,\n  }));\n\n  useEffect(() => {\n    // 创建占位节点\n    placeholderEL.current = document.createElement('div');\n  }, []);\n\n  useEffect(() => {\n    scrollContainer.current = getScrollContainer(container);\n    if (scrollContainer.current) {\n      handleScroll();\n      scrollContainer.current.addEventListener('scroll', handleScroll);\n      window.addEventListener('resize', handleScroll);\n\n      return () => {\n        scrollContainer.current.removeEventListener('scroll', handleScroll);\n        window.removeEventListener('resize', handleScroll);\n      };\n    }\n  }, [container, handleScroll]);\n\n  return (\n    <div ref={affixWrapRef} className={className} style={style}>\n      <div ref={affixRef}>{children || content}</div>\n    </div>\n  );\n});\n\nAffix.displayName = 'Affix';\n\nexport default Affix;\n"],"names":["Affix","forwardRef","props","ref","_useDefaultProps","useDefaultProps","affixDefaultProps","children","content","zIndex","container","offsetBottom","offsetTop","className","style","onFixedChange","_useConfig","useConfig","classPrefix","affixRef","useRef","affixWrapRef","placeholderEL","scrollContainer","ticking","handleScroll","useCallback","current","window","requestAnimationFrame","_affixWrapRef$current","_affixWrapRef$current2","_scrollContainer$curr","_ref","getBoundingClientRect","top","_ref$top","wrapToTop","_ref$width","width","wrapWidth","_ref$height","height","wrapHeight","containerToTop","HTMLElement","calcTop","containerHeight","Window","calcBottom","fixedTop","affixed","placeholderStatus","contains","prePlaceholderStatus","concat","appendChild","removeAttribute","remove","isFunction","useImperativeHandle","useEffect","document","createElement","getScrollContainer","addEventListener","removeEventListener","React","displayName"],"mappings":"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"}