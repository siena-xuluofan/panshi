{"version":3,"file":"useSingle.js","sources":["../../../components/select-input/useSingle.tsx"],"sourcesContent":["import React, { useRef } from 'react';\n\nimport classNames from 'classnames';\nimport { isObject, pick } from 'lodash-es';\n\nimport useConfig from '../hooks/useConfig';\nimport useControlled from '../hooks/useControlled';\nimport Input, { type InputRef, type TdInputProps } from '../input';\nimport Loading from '../loading';\n\nimport type { SelectInputCommonProperties } from './interface';\nimport type { TdSelectInputProps } from './type';\n\nexport interface RenderSelectSingleInputParams {\n  tPlaceholder: string;\n}\n\n// single 和 multiple 共有特性\nconst COMMON_PROPERTIES = [\n  'status',\n  'clearable',\n  'disabled',\n  'label',\n  'placeholder',\n  'readonly',\n  'suffix',\n  'suffixIcon',\n  'onPaste',\n  'onEnter',\n  'onMouseenter',\n  'onMouseleave',\n  'size',\n  'prefixIcon',\n];\n\nconst DEFAULT_KEYS: TdSelectInputProps['keys'] = {\n  label: 'label',\n  value: 'value',\n};\n\nfunction getInputValue(value: TdSelectInputProps['value'], keys: TdSelectInputProps['keys']) {\n  const iKeys = keys || DEFAULT_KEYS;\n  return isObject(value) ? value[iKeys.label] : value;\n}\n\nexport default function useSingle(props: TdSelectInputProps) {\n  const { value, keys, loading } = props;\n  const { classPrefix } = useConfig();\n\n  const inputRef = useRef<InputRef>(null);\n  const blurTimeoutRef = useRef(null);\n\n  const [inputValue, setInputValue] = useControlled(props, 'inputValue', props.onInputChange);\n\n  const commonInputProps: SelectInputCommonProperties = {\n    ...pick(props, COMMON_PROPERTIES),\n    suffixIcon: loading ? <Loading loading size=\"small\" /> : props.suffixIcon,\n  };\n\n  const onInnerClear = (context: { e: React.MouseEvent<SVGSVGElement> }) => {\n    context?.e?.stopPropagation();\n    props.onClear?.(context);\n    setInputValue('', { trigger: 'clear' });\n  };\n\n  const onInnerInputChange: TdInputProps['onChange'] = (value, context) => {\n    if (props.allowInput) {\n      setInputValue(value, { ...context, trigger: 'input' });\n    }\n  };\n\n  const renderSelectSingle = (\n    popupVisible: boolean,\n    onInnerBlur?: (context: { e: React.FocusEvent<HTMLInputElement> }) => void,\n  ) => {\n    // 单选，值的呈现方式\n    const singleValueDisplay: any = !props.multiple ? props.valueDisplay : null;\n    const displayedValue = popupVisible && props.allowInput ? inputValue : getInputValue(value, keys);\n\n    const handleBlur = (value, ctx) => {\n      if (blurTimeoutRef.current) {\n        clearTimeout(blurTimeoutRef.current);\n      }\n      // 强制把 popupVisible 设置为 false 时，点击 input，会出现 blur -> focus 的情况，因此忽略前面短暂的 blur 事件\n      blurTimeoutRef.current = setTimeout(() => {\n        if (blurTimeoutRef.current) {\n          if (!popupVisible) {\n            onInnerBlur(ctx);\n          } else if (!props.panel) {\n            props.onBlur?.(value, { e: ctx.e, inputValue: value });\n          }\n        }\n        blurTimeoutRef.current = null;\n      }, 150);\n    };\n\n    const handleFocus = (val, context) => {\n      if (blurTimeoutRef.current) {\n        clearTimeout(blurTimeoutRef.current);\n        blurTimeoutRef.current = null;\n      }\n      props.onFocus?.(value, { ...context, inputValue: val });\n      // focus might not need to change input value. it will caught some curious errors in tree-select\n      // !popupVisible && setInputValue(getInputValue(value, keys), { ...context, trigger: 'input' });\n    };\n\n    return (\n      <Input\n        ref={inputRef}\n        {...commonInputProps}\n        autoWidth={props.autoWidth}\n        allowInput={props.allowInput}\n        placeholder={singleValueDisplay ? '' : props.placeholder}\n        value={singleValueDisplay ? ' ' : displayedValue}\n        label={\n          (props.label || singleValueDisplay) && (\n            <>\n              {props.label}\n              {singleValueDisplay as React.ReactNode}\n            </>\n          )\n        }\n        onChange={onInnerInputChange}\n        onClear={onInnerClear}\n        // [Important Info]: SelectInput.blur is not equal to Input, example: click popup panel\n        onFocus={handleFocus}\n        onEnter={(val, context) => {\n          props.onEnter?.(value, { ...context, inputValue: val });\n        }}\n        // onBlur need to triggered by input when popup panel is null or when popupVisible is forced to false\n        onBlur={handleBlur}\n        {...props.inputProps}\n        inputClass={classNames(props.inputProps?.className, {\n          [`${classPrefix}-input--focused`]: popupVisible,\n          [`${classPrefix}-is-focused`]: popupVisible,\n        })}\n      />\n    );\n  };\n\n  return {\n    inputRef,\n    commonInputProps,\n    singleInputValue: inputValue,\n    onInnerClear,\n    renderSelectSingle,\n  };\n}\n"],"names":["COMMON_PROPERTIES","DEFAULT_KEYS","label","value","getInputValue","keys","iKeys","isObject","useSingle","props","loading","_useConfig","useConfig","classPrefix","inputRef","useRef","blurTimeoutRef","_useControlled","useControlled","onInputChange","_useControlled2","_slicedToArray","inputValue","setInputValue","commonInputProps","_objectSpread","pick","suffixIcon","React","createElement","Loading","size","onInnerClear","context","_context$e","_props$onClear","e","stopPropagation","onClear","call","trigger","onInnerInputChange","allowInput","renderSelectSingle","popupVisible","onInnerBlur","_props$inputProps","singleValueDisplay","multiple","valueDisplay","displayedValue","handleBlur","ctx","current","clearTimeout","setTimeout","panel","_props$onBlur","onBlur","handleFocus","val","_props$onFocus","onFocus","Input","ref","autoWidth","placeholder","Fragment","onChange","onEnter","_props$onEnter","inputProps","inputClass","classNames","className","_defineProperty","concat","singleInputValue"],"mappings":"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"}