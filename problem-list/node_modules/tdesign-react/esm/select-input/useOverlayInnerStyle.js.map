{"version":3,"file":"useOverlayInnerStyle.js","sources":["../../../components/select-input/useOverlayInnerStyle.ts"],"sourcesContent":["import { isFunction, isObject } from 'lodash-es';\nimport React, { useMemo, useRef } from 'react';\n\nimport useControlled from '../hooks/useControlled';\n\nimport type { PopupVisibleChangeContext, TdPopupProps } from '../popup';\nimport type { TdSelectInputProps } from './type';\n\nexport type overlayStyleProps = Pick<\n  TdSelectInputProps,\n  | 'popupProps'\n  | 'autoWidth'\n  | 'readonly'\n  | 'onPopupVisibleChange'\n  | 'disabled'\n  | 'allowInput'\n  | 'popupVisible'\n  | 'defaultPopupVisible'\n>;\n\n// 单位：px\nconst MAX_POPUP_WIDTH = 1000;\n\nexport default function useOverlayInnerStyle(\n  props: overlayStyleProps,\n  extra?: {\n    afterHidePopup?: (ctx: PopupVisibleChangeContext) => void;\n  },\n) {\n  const { popupProps, autoWidth, readonly, disabled, onPopupVisibleChange, allowInput } = props;\n  const [innerPopupVisible, setInnerPopupVisible] = useControlled(props, 'popupVisible', onPopupVisibleChange);\n\n  const skipNextBlur = useRef(false);\n\n  const matchWidthFunc = (triggerElement: HTMLElement, popupElement: HTMLElement) => {\n    if (!triggerElement || !popupElement) return;\n\n    const prevDisplay = popupElement.style.display;\n    // 设置display来可以获取popupElement的宽度\n    // eslint-disable-next-line no-param-reassign\n    popupElement.style.display = '';\n    // popupElement的scrollBar宽度\n    const overlayScrollWidth = popupElement.offsetWidth - popupElement.scrollWidth;\n\n    /**\n     * issue：https://github.com/Tencent/tdesign-react/issues/2642\n     *\n     * popupElement的内容宽度不超过triggerElement的宽度，就使用triggerElement的宽度减去popup的滚动条宽度，\n     * 让popupElement的宽度加上scrollBar的宽度等于triggerElement的宽度；\n     *\n     * popupElement的内容宽度超过triggerElement的宽度，就使用popupElement的scrollWidth，\n     * 不用offsetWidth是会包含scrollBar的宽度\n     */\n    const width =\n      popupElement.offsetWidth - overlayScrollWidth > triggerElement.offsetWidth\n        ? popupElement.scrollWidth\n        : triggerElement.offsetWidth - overlayScrollWidth;\n\n    if (prevDisplay === 'none') {\n      // eslint-disable-next-line no-param-reassign\n      popupElement.style.display = 'none';\n    }\n    let otherOverlayInnerStyle: React.CSSProperties = {};\n    if (popupProps && typeof popupProps.overlayInnerStyle === 'object' && !popupProps.overlayInnerStyle.width) {\n      otherOverlayInnerStyle = popupProps.overlayInnerStyle;\n    }\n    return {\n      width: `${Math.min(width, MAX_POPUP_WIDTH)}px`,\n      ...otherOverlayInnerStyle,\n    };\n  };\n\n  const onInnerPopupVisibleChange = (visible: boolean, context: PopupVisibleChangeContext) => {\n    skipNextBlur.current = false;\n    if (disabled || readonly) return;\n    // 如果点击触发元素（输入框）且为可输入状态，则继续显示下拉框\n    const newVisible = context.trigger === 'trigger-element-click' && allowInput ? true : visible;\n    if (props.popupVisible !== newVisible) {\n      setInnerPopupVisible(newVisible, context);\n      if (!newVisible) {\n        extra?.afterHidePopup?.(context);\n        skipNextBlur.current = true;\n      }\n    }\n  };\n\n  const tOverlayInnerStyle = useMemo(() => {\n    let result: TdPopupProps['overlayInnerStyle'] = {};\n    const overlayInnerStyle = popupProps?.overlayInnerStyle || {};\n    if (isFunction(overlayInnerStyle) || (isObject(overlayInnerStyle) && overlayInnerStyle.width)) {\n      result = overlayInnerStyle;\n    } else if (!autoWidth) {\n      result = matchWidthFunc;\n    }\n    return result;\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [autoWidth, popupProps?.overlayInnerStyle]);\n\n  return {\n    tOverlayInnerStyle,\n    innerPopupVisible,\n    skipNextBlur,\n    onInnerPopupVisibleChange,\n  };\n}\n"],"names":["MAX_POPUP_WIDTH","useOverlayInnerStyle","props","extra","popupProps","autoWidth","readonly","disabled","onPopupVisibleChange","allowInput","_useControlled","useControlled","_useControlled2","_slicedToArray","innerPopupVisible","setInnerPopupVisible","skipNextBlur","useRef","matchWidthFunc","triggerElement","popupElement","prevDisplay","style","display","overlayScrollWidth","offsetWidth","scrollWidth","width","otherOverlayInnerStyle","_typeof","overlayInnerStyle","_objectSpread","concat","Math","min","onInnerPopupVisibleChange","visible","context","current","newVisible","trigger","popupVisible","_extra$afterHidePopup","afterHidePopup","call","tOverlayInnerStyle","useMemo","result","isFunction","isObject"],"mappings":"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"}