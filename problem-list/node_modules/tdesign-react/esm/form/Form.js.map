{"version":3,"file":"Form.js","sources":["../../../components/form/Form.tsx"],"sourcesContent":["import React, { useRef, useImperativeHandle, useEffect } from 'react';\nimport classNames from 'classnames';\nimport forwardRefWithStatics from '../_util/forwardRefWithStatics';\nimport noop from '../_util/noop';\nimport useConfig from '../hooks/useConfig';\nimport useDefaultProps from '../hooks/useDefaultProps';\nimport FormContext from './FormContext';\nimport FormItem from './FormItem';\nimport FormList from './FormList';\nimport { formDefaultProps } from './defaultProps';\nimport useForm, { HOOK_MARK } from './hooks/useForm';\nimport useInstance from './hooks/useInstance';\nimport useWatch from './hooks/useWatch';\n\nimport type { StyledProps } from '../common';\nimport type { TdFormProps } from './type';\n\nexport interface FormProps extends TdFormProps, StyledProps {\n  children?: React.ReactNode;\n}\n\nconst Form = forwardRefWithStatics(\n  (originalProps: FormProps, ref) => {\n    const { classPrefix, form: globalFormConfig } = useConfig();\n    const props = useDefaultProps<FormProps>(originalProps, formDefaultProps);\n    const {\n      style,\n      className,\n      labelWidth,\n      statusIcon,\n      labelAlign,\n      layout,\n      colon,\n      initialData,\n      requiredMark = globalFormConfig.requiredMark,\n      requiredMarkPosition = globalFormConfig.requiredMarkPosition,\n      scrollToFirstError,\n      showErrorMessage,\n      resetType,\n      rules,\n      errorMessage = globalFormConfig.errorMessage,\n      preventSubmitDefault,\n      disabled,\n      readonly,\n      children,\n      id,\n      onReset,\n      onValuesChange = noop,\n    } = props;\n\n    const formClass = classNames(`${classPrefix}-form`, className, {\n      [`${classPrefix}-form-inline`]: layout === 'inline',\n    });\n\n    const [form] = useForm(props.form); // 内部与外部共享 form 实例，外部不传则内部创建\n    const formRef = useRef<HTMLFormElement>(null);\n    const formMapRef = useRef(new Map()); // 收集所有包含 name 属性 formItem 实例\n    const floatingFormDataRef = useRef({}); // 储存游离值的 formData\n    const formInstance = useInstance(props, formRef, formMapRef, floatingFormDataRef);\n\n    useImperativeHandle(ref, () => formInstance);\n    Object.assign(form, { ...formInstance });\n    form?.getInternalHooks?.(HOOK_MARK)?.setForm?.(formInstance);\n\n    // form 初始化后清空队列\n    useEffect(() => {\n      form?.getInternalHooks?.(HOOK_MARK)?.flashQueue?.();\n    }, [form]);\n\n    function onResetHandler(e: React.FormEvent<HTMLFormElement>) {\n      [...formMapRef.current.values()].forEach((formItemRef) => {\n        formItemRef?.current.resetField();\n      });\n      form?.getInternalHooks?.(HOOK_MARK)?.notifyWatch?.([]);\n      form.store = {};\n      onReset?.({ e });\n    }\n\n    function onFormItemValueChange(changedValue: Record<string, unknown>) {\n      const allFields = formInstance.getFieldsValue(true);\n      onValuesChange(changedValue, allFields);\n    }\n\n    function onKeyDownHandler(e: React.KeyboardEvent<HTMLFormElement>) {\n      // 禁用 input 输入框回车自动提交 form\n      if ((e.target as Element).tagName.toLowerCase() !== 'input') return;\n      if (preventSubmitDefault && e.key === 'Enter') {\n        e.preventDefault?.();\n        e.stopPropagation?.();\n      }\n    }\n\n    return (\n      <FormContext.Provider\n        value={{\n          form,\n          labelWidth,\n          statusIcon,\n          labelAlign,\n          layout,\n          colon,\n          initialData,\n          requiredMark,\n          requiredMarkPosition,\n          errorMessage,\n          showErrorMessage,\n          scrollToFirstError,\n          resetType,\n          rules,\n          disabled,\n          readonly,\n          formMapRef,\n          floatingFormDataRef,\n          onFormItemValueChange,\n        }}\n      >\n        <form\n          ref={formRef}\n          id={id}\n          style={style}\n          className={formClass}\n          onSubmit={formInstance.submit}\n          onReset={onResetHandler}\n          onKeyDown={onKeyDownHandler}\n        >\n          {children}\n        </form>\n      </FormContext.Provider>\n    );\n  },\n  { useForm, useWatch, FormItem, FormList },\n);\n\nForm.displayName = 'Form';\n\nexport default Form;\n"],"names":["Form","forwardRefWithStatics","originalProps","ref","_form$getInternalHook","_form$getInternalHook2","_useConfig","useConfig","classPrefix","globalFormConfig","form","props","useDefaultProps","formDefaultProps","style","className","labelWidth","statusIcon","labelAlign","layout","colon","initialData","_props$requiredMark","requiredMark","_props$requiredMarkPo","requiredMarkPosition","scrollToFirstError","showErrorMessage","resetType","rules","_props$errorMessage","errorMessage","preventSubmitDefault","disabled","readonly","children","id","onReset","_props$onValuesChange","onValuesChange","noop","formClass","classNames","concat","_defineProperty","_useForm","useForm","_useForm2","_slicedToArray","formRef","useRef","formMapRef","Map","floatingFormDataRef","formInstance","useInstance","useImperativeHandle","Object","assign","_objectSpread","getInternalHooks","call","HOOK_MARK","setForm","useEffect","_form$getInternalHook3","_form$getInternalHook4","flashQueue","onResetHandler","e","_form$getInternalHook5","_form$getInternalHook6","_toConsumableArray","current","values","forEach","formItemRef","resetField","notifyWatch","store","onFormItemValueChange","changedValue","allFields","getFieldsValue","onKeyDownHandler","target","tagName","toLowerCase","key","_e$preventDefault","_e$stopPropagation","preventDefault","stopPropagation","React","createElement","FormContext","Provider","value","onSubmit","submit","onKeyDown","useWatch","FormItem","FormList","displayName"],"mappings":"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"}