<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>问题处理</title>
    <link rel="stylesheet" href="https://unpkg.com/tdesign-react@1.6.0/dist/tdesign.min.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/tdesign-react@1.6.0/dist/tdesign.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif, 'Apple Color Emoji',
                'Segoe UI Emoji', 'Segoe UI Symbol';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f5f5f5;
        }
        
        .page-container {
            padding: 24px;
            min-height: 100vh;
            background-color: #f5f5f5;
        }
        
        .page-header {
            background-color: #fff;
            padding: 16px 24px;
            margin-bottom: 24px;
            border-radius: 6px;
            box-shadow: 0 1px 0 0 rgba(0, 0, 0, 0.05);
        }
        
        .page-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            color: rgba(0, 0, 0, 0.85);
        }
        
        .content-card {
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px 0 rgba(0, 0, 0, 0.02);
            margin-bottom: 24px;
            padding: 24px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: rgba(0, 0, 0, 0.85);
        }
        
        .action-buttons {
            margin-bottom: 16px;
        }
        
        .comment-input {
            margin-bottom: 16px;
        }
        
        .comment-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .comment-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 16px 0;
        }
        
        .comment-item:last-child {
            border-bottom: none;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .comment-author {
            font-weight: 500;
            color: rgba(0, 0, 0, 0.85);
        }
        
        .comment-time {
            color: rgba(0, 0, 0, 0.45);
            font-size: 12px;
        }
        
        .comment-content {
            color: rgba(0, 0, 0, 0.85);
            line-height: 1.5;
        }
        
        .t-table {
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { 
            Button, 
            Form, 
            Input, 
            DatePicker, 
            Table, 
            Modal, 
            Card, 
            Space,
            Divider,
            Tag,
            MessagePlugin
        } = TDesignReact;
        
        const { FormItem } = Form;
        const { TextArea } = Input;
        const dayjs = window.dayjs;

        // 模拟处理记录数据
        const mockRecords = [
            {
                id: 1,
                createTime: '2023-11-20 10:30:00',
                issue: '修复登录页面BUG',
                processor: '张三',
                estimatedCompleteTime: '2023-11-21 18:00:00',
                actualCompleteTime: '2023-11-21 15:30:00',
                result: '已修复',
                resultFiller: '李四'
            },
            {
                id: 2,
                createTime: '2023-11-19 14:20:00',
                issue: '优化数据库查询性能',
                processor: '王五',
                estimatedCompleteTime: '2023-11-20 12:00:00',
                actualCompleteTime: '',
                result: '',
                resultFiller: ''
            },
            {
                id: 3,
                createTime: '2023-11-18 09:15:00',
                issue: '更新用户手册文档',
                processor: '赵六',
                estimatedCompleteTime: '2023-11-19 17:00:00',
                actualCompleteTime: '2023-11-19 16:45:00',
                result: '已完成',
                resultFiller: '赵六'
            }
        ];

        // 模拟评论数据
        const mockComments = [
            {
                id: 1,
                author: '李四',
                time: '2023-11-20 16:30:00',
                content: '登录页面BUG已经修复，请测试验证。'
            },
            {
                id: 2,
                author: '张三',
                time: '2023-11-20 17:15:00',
                content: '测试通过，功能正常。'
            },
            {
                id: 3,
                author: '王五',
                time: '2023-11-21 09:45:00',
                content: '数据库查询优化方案已实施，性能提升约30%。'
            }
        ];

        function App() {
            const [visible, setVisible] = useState(false);
            const [resultVisible, setResultVisible] = useState(false);
            const [records, setRecords] = useState(mockRecords);
            const [comments, setComments] = useState(mockComments);
            const [currentRecordId, setCurrentRecordId] = useState(null);
            const [newComment, setNewComment] = useState('');
            const [formData, setFormData] = useState({
                issue: '',
                processor: '',
                estimatedCompleteTime: '',
                actualCompleteTime: ''
            });
            const [resultForm, setResultForm] = useState({
                result: '',
                actualCompleteTime: ''
            });

            // 打开新增处理事项弹窗
            const handleAddIssue = () => {
                setVisible(true);
            };

            // 提交新增处理事项
            const handleSubmit = () => {
                if (!formData.issue || !formData.processor || !formData.estimatedCompleteTime) {
                    MessagePlugin.error('请填写所有必填项');
                    return;
                }

                const newRecord = {
                    id: records.length + 1,
                    createTime: dayjs().format('YYYY-MM-DD HH:mm:ss'),
                    issue: formData.issue,
                    processor: formData.processor,
                    estimatedCompleteTime: dayjs(formData.estimatedCompleteTime).format('YYYY-MM-DD HH:mm:ss'),
                    actualCompleteTime: formData.actualCompleteTime ? dayjs(formData.actualCompleteTime).format('YYYY-MM-DD HH:mm:ss') : '',
                    result: '',
                    resultFiller: ''
                };

                setRecords([newRecord, ...records]);
                setVisible(false);
                setFormData({
                    issue: '',
                    processor: '',
                    estimatedCompleteTime: '',
                    actualCompleteTime: ''
                });
                MessagePlugin.success('处理事项添加成功');
            };

            // 打开处理结果弹窗
            const handleOpenResultModal = (record) => {
                setCurrentRecordId(record.id);
                setResultVisible(true);
                setResultForm({
                    result: record.result,
                    actualCompleteTime: record.actualCompleteTime ? dayjs(record.actualCompleteTime) : ''
                });
            };

            // 提交处理结果
            const handleResultSubmit = () => {
                if (!resultForm.result) {
                    MessagePlugin.error('请填写处理结果');
                    return;
                }

                const updatedRecords = records.map(record => {
                    if (record.id === currentRecordId) {
                        return {
                            ...record,
                            result: resultForm.result,
                            actualCompleteTime: resultForm.actualCompleteTime ? dayjs(resultForm.actualCompleteTime).format('YYYY-MM-DD HH:mm:ss') : dayjs().format('YYYY-MM-DD HH:mm:ss'),
                            resultFiller: '当前用户' // 实际应用中应为当前登录用户
                        };
                    }
                    return record;
                });

                setRecords(updatedRecords);
                setResultVisible(false);
                MessagePlugin.success('处理结果已更新');
            };

            // 添加评论
            const handleAddComment = () => {
                if (!newComment.trim()) {
                    MessagePlugin.error('请输入评论内容');
                    return;
                }

                const comment = {
                    id: comments.length + 1,
                    author: '当前用户', // 实际应用中应为当前登录用户
                    time: dayjs().format('YYYY-MM-DD HH:mm:ss'),
                    content: newComment
                };

                setComments([comment, ...comments]);
                setNewComment('');
                MessagePlugin.success('评论添加成功');
            };

            // 处理记录表格列定义
            const columns = [
                {
                    title: '创建时间',
                    dataIndex: 'createTime',
                    key: 'createTime',
                    width: 180
                },
                {
                    title: '处理事项',
                    dataIndex: 'issue',
                    key: 'issue'
                },
                {
                    title: '处理人',
                    dataIndex: 'processor',
                    key: 'processor',
                    width: 120
                },
                {
                    title: '预计完成时间',
                    dataIndex: 'estimatedCompleteTime',
                    key: 'estimatedCompleteTime',
                    width: 180
                },
                {
                    title: '实际完成时间',
                    dataIndex: 'actualCompleteTime',
                    key: 'actualCompleteTime',
                    width: 180
                },
                {
                    title: '处理结果',
                    dataIndex: 'result',
                    key: 'result',
                    width: 120,
                    cell: (context) => {
                        const { row } = context;
                        return (
                            <Space>
                                {row.result ? <Tag theme="success">{row.result}</Tag> : '-'}
                                {!row.result && (
                                    <Button 
                                        size="small" 
                                        variant="text" 
                                        onClick={() => handleOpenResultModal(row)}
                                    >
                                        填写
                                    </Button>
                                )}
                            </Space>
                        );
                    }
                },
                {
                    title: '处理完成填写人',
                    dataIndex: 'resultFiller',
                    key: 'resultFiller',
                    width: 120
                }
            ];

            return (
                <div className="page-container">
                    <div className="page-header">
                        <h1 className="page-title">问题处理</h1>
                    </div>

                    {/* 处理记录部分 */}
                    <Card className="content-card">
                        <div className="section-title">处理记录</div>
                        <div className="action-buttons">
                            <Button 
                                theme="primary" 
                                icon={<TDesignReactIcon.AddIcon />}
                                onClick={handleAddIssue}
                            >
                                新增处理事项
                            </Button>
                        </div>
                        <Table
                            data={records}
                            columns={columns}
                            rowKey="id"
                            pagination={false}
                        />
                    </Card>

                    {/* 评论部分 */}
                    <Card className="content-card">
                        <div className="section-title">评论</div>
                        <div className="comment-input">
                            <Space direction="vertical" style={{ width: '100%' }}>
                                <TextArea
                                    placeholder="请输入评论内容"
                                    value={newComment}
                                    onChange={(value) => setNewComment(value)}
                                    autos={{ minRows: 3, maxRows: 6 }}
                                />
                                <div style={{ textAlign: 'right' }}>
                                    <Button theme="primary" onClick={handleAddComment}>
                                        提交评论
                                    </Button>
                                </div>
                            </Space>
                        </div>
                        <Divider />
                        <div className="comment-list">
                            {comments.map(comment => (
                                <div key={comment.id} className="comment-item">
                                    <div className="comment-header">
                                        <span className="comment-author">{comment.author}</span>
                                        <span className="comment-time">{comment.time}</span>
                                    </div>
                                    <div className="comment-content">{comment.content}</div>
                                </div>
                            ))}
                        </div>
                    </Card>

                    {/* 新增处理事项弹窗 */}
                    <Modal
                        header="新增处理事项"
                        visible={visible}
                        onClose={() => setVisible(false)}
                        onConfirm={handleSubmit}
                        confirmBtn="确定"
                        cancelBtn="取消"
                    >
                        <Form>
                            <FormItem label="处理事项" name="issue" required>
                                <Input
                                    placeholder="请输入处理事项"
                                    value={formData.issue}
                                    onChange={(value) => setFormData({ ...formData, issue: value })}
                                />
                            </FormItem>
                            <FormItem label="处理人" name="processor" required>
                                <Input
                                    placeholder="请输入处理人"
                                    value={formData.processor}
                                    onChange={(value) => setFormData({ ...formData, processor: value })}
                                />
                            </FormItem>
                            <FormItem label="预计完成时间" name="estimatedCompleteTime" required>
                                <DatePicker
                                    enableTimePicker
                                    format="YYYY-MM-DD HH:mm:ss"
                                    placeholder="请选择预计完成时间"
                                    value={formData.estimatedCompleteTime ? dayjs(formData.estimatedCompleteTime) : ''}
                                    onChange={(value) => setFormData({ ...formData, estimatedCompleteTime: value })}
                                />
                            </FormItem>
                            <FormItem label="实际完成时间" name="actualCompleteTime">
                                <DatePicker
                                    enableTimePicker
                                    format="YYYY-MM-DD HH:mm:ss"
                                    placeholder="请选择实际完成时间（可选）"
                                    value={formData.actualCompleteTime ? dayjs(formData.actualCompleteTime) : ''}
                                    onChange={(value) => setFormData({ ...formData, actualCompleteTime: value })}
                                />
                            </FormItem>
                        </Form>
                    </Modal>

                    {/* 处理结果弹窗 */}
                    <Modal
                        header="填写处理结果"
                        visible={resultVisible}
                        onClose={() => setResultVisible(false)}
                        onConfirm={handleResultSubmit}
                        confirmBtn="确定"
                        cancelBtn="取消"
                    >
                        <Form>
                            <FormItem label="处理结果" name="result" required>
                                <Input
                                    placeholder="请输入处理结果"
                                    value={resultForm.result}
                                    onChange={(value) => setResultForm({ ...resultForm, result: value })}
                                />
                            </FormItem>
                            <FormItem label="实际完成时间" name="actualCompleteTime">
                                <DatePicker
                                    enableTimePicker
                                    format="YYYY-MM-DD HH:mm:ss"
                                    placeholder="请选择实际完成时间"
                                    value={resultForm.actualCompleteTime}
                                    onChange={(value) => setResultForm({ ...resultForm, actualCompleteTime: value })}
                                />
                            </FormItem>
                        </Form>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <!-- 加载Babel转译器 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 加载TDesign图标库 -->
    <script src="https://unpkg.com/tdesign-icons-react@0.2.2/dist/index.min.js"></script>
</body>
</html>